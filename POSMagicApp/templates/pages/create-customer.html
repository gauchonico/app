{% extends 'base.html' %}

{% load static %}

{% block title %}Starter Page{% endblock %}
{% block css %}
	<link href="{% static 'plugins/tag-it/css/jquery.tagit.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/bootstrap-daterangepicker/daterangepicker.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/bootstrap-slider/dist/css/bootstrap-slider.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/blueimp-file-upload/css/jquery.fileupload.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/summernote/dist/summernote-lite.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/spectrum-colorpicker2/dist/spectrum.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/select-picker/dist/picker.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/jquery-typeahead/dist/jquery.typeahead.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block js %}
	<script src="{% static 'plugins/jquery-migrate/dist/jquery-migrate.min.js' %}"></script>
	<script src="{% static 'plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js' %}"></script>
	<script src="{% static 'plugins/moment/min/moment.min.js' %}"></script>
	<script src="{% static 'plugins/bootstrap-daterangepicker/daterangepicker.js' %}"></script>
	<script src="{% static 'plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js' %}"></script>
	<script src="{% static 'plugins/bootstrap-slider/dist/bootstrap-slider.min.js' %}"></script>
	<script src="{% static 'plugins/jquery-typeahead/dist/jquery.typeahead.min.js' %}"></script>
	<script src="{% static 'plugins/jquery.maskedinput/src/jquery.maskedinput.js' %}"></script>
	<script src="{% static 'plugins/tag-it/js/tag-it.min.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/vendor/jquery.ui.widget.js' %}"></script>
	<script src="{% static 'plugins/blueimp-tmpl/js/tmpl.min.js' %}"></script>
	<script src="{% static 'plugins/blueimp-load-image/js/load-image.all.min.js' %}"></script>
	<script src="{% static 'plugins/blueimp-canvas-to-blob/js/canvas-to-blob.min.js' %}"></script>
	<script src="{% static 'plugins/blueimp-gallery/js/jquery.blueimp-gallery.min.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.iframe-transport.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload-process.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload-image.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload-audio.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload-video.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload-validate.js' %}"></script>
	<script src="{% static 'plugins/blueimp-file-upload/js/jquery.fileupload-ui.js' %}"></script>
	<script src="{% static 'plugins/summernote/dist/summernote-lite.min.js' %}"></script>
	<script src="{% static 'plugins/spectrum-colorpicker2/dist/spectrum.min.js' %}"></script>
	<script src="{% static 'plugins/select-picker/dist/picker.min.js' %}"></script>
	<script src="{% static 'plugins/@highlightjs/cdn-assets/highlight.min.js' %}"></script>
	<script src="{% static 'js/demo/highlightjs.demo.js' %}"></script>
	<script src="{% static 'js/demo/form-plugins.demo.js' %}"></script>
	<script src="{% static 'js/demo/sidebar-scrollspy.demo.js' %}"></script>
	
	<script>
		$(document).ready(function() {
			// Show/hide sex field based on customer type
			function toggleSexField() {
				const customerType = $('#id_type_of_customer').val();
				const sexField = $('#sex-field');
				const sexInput = $('#id_sex');
				
				if (customerType === 'CLIENT') {
					sexField.show();
					sexInput.prop('required', true);
				} else {
					sexField.hide();
					sexInput.prop('required', false);
					sexInput.val('');
				}
			}
			
			// Show/hide guardian fields based on is_minor checkbox
			function toggleGuardianFields() {
				const isMinor = $('#id_is_minor').is(':checked');
				const guardianField = $('#guardian-field');
				const relationshipField = $('#relationship-field');
				const guardianSelect = $('#id_guardian');
				const relationshipSelect = $('#id_relationship_to_guardian');
				
				if (isMinor) {
					guardianField.show();
					relationshipField.show();
					guardianSelect.prop('required', true);
					relationshipSelect.prop('required', true);
				} else {
					guardianField.hide();
					relationshipField.hide();
					guardianSelect.prop('required', false);
					relationshipSelect.prop('required', false);
					guardianSelect.val('');
					relationshipSelect.val('SELF');
				}
			}
			
			// Auto-calculate age and set is_minor based on date of birth
			function updateAgeAndMinorStatus() {
				const dobValue = $('#id_date_of_birth').val();
				if (dobValue) {
					const dob = new Date(dobValue);
					const today = new Date();
					let age = today.getFullYear() - dob.getFullYear();
					const monthDiff = today.getMonth() - dob.getMonth();
					
					if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
						age--;
					}
					
					if (age < 18) {
						$('#id_is_minor').prop('checked', true);
						toggleGuardianFields();
					} else {
						$('#id_is_minor').prop('checked', false);
						toggleGuardianFields();
					}
				}
			}
			
			// Event listeners
			$('#id_type_of_customer').on('change', toggleSexField);
			$('#id_is_minor').on('change', toggleGuardianFields);
			$('#id_date_of_birth').on('change', updateAgeAndMinorStatus);
			
			// Initialize on page load
			toggleSexField();
			toggleGuardianFields();
			updateAgeAndMinorStatus();
			
			// Form validation
			$('form').on('submit', function(e) {
				const customerType = $('#id_type_of_customer').val();
				const sex = $('#id_sex').val();
				const isMinor = $('#id_is_minor').is(':checked');
				const guardian = $('#id_guardian').val();
				
				// Validate sex for clients
				if (customerType === 'CLIENT' && !sex) {
					e.preventDefault();
					alert('Gender is required for clients.');
					$('#id_sex').focus();
					return false;
				}
				
				// Validate guardian for minors
				if (isMinor && !guardian) {
					e.preventDefault();
					alert('Guardian is required for minors.');
					$('#id_guardian').focus();
					return false;
				}
			});
			
			// Auto-format phone number
			$('#id_phone').on('input', function() {
				let value = $(this).val().replace(/\D/g, '');
				if (value.length > 0) {
					// Format as Uganda phone number
					if (value.startsWith('256')) {
						value = '+' + value;
					} else if (value.startsWith('0')) {
						value = '+256' + value.substring(1);
					} else if (value.length === 9) {
						value = '+256' + value;
					}
				}
				$(this).val(value);
			});
			
			// Customer Search Functionality
			let searchTimeout;
			$('#guardian-search').on('input', function() {
				const query = $(this).val().trim();
				const resultsContainer = $('#guardian-search-results');
				
				// Clear previous timeout
				clearTimeout(searchTimeout);
				
				if (query.length < 2) {
					resultsContainer.addClass('d-none').empty();
					return;
				}
				
				// Add a small delay to avoid excessive requests
				searchTimeout = setTimeout(function() {
					searchCustomers(query);
				}, 300);
			});
			
			function searchCustomers(query) {
				const resultsContainer = $('#guardian-search-results');
				
				// Show loading state
				resultsContainer.removeClass('d-none').html(
					'<div class="p-3 text-center"><i class="fas fa-spinner fa-spin"></i> Searching...</div>'
				);
				
				$.ajax({
					url: '{% url "DjangoHUDApp:search_customers" %}',
					method: 'GET',
					data: {
						'q': query,
						'guardian_only': 'true'  // Only return potential guardians
					},
					success: function(data) {
						displaySearchResults(data.customers);
					},
					error: function() {
						resultsContainer.html(
							'<div class="p-3 text-danger"><i class="fas fa-exclamation-circle"></i> Error searching customers</div>'
						);
					}
				});
			}
			
			function displaySearchResults(customers) {
				const resultsContainer = $('#guardian-search-results');
				
				if (customers.length === 0) {
					resultsContainer.html(
						'<div class="p-3 text-muted text-center"><i class="fas fa-search"></i> No customers found</div>'
					);
					return;
				}
				
				let html = '';
				customers.forEach(function(customer) {
					const kycBadge = customer.kyc_verified ? 
						'<span class="badge bg-success ms-2">KYC Verified</span>' : 
						'<span class="badge bg-warning ms-2">Not Verified</span>';
					
					html += `
						<div class="customer-result p-3 border-bottom" data-customer-id="${customer.id}" style="cursor: pointer;">
							<div class="d-flex justify-content-between align-items-center">
								<div>
									<strong>${customer.name}</strong>
									${kycBadge}
									<br>
									<small class="text-muted">
										<i class="fas fa-phone"></i> ${customer.phone}
										${customer.email ? `<i class="fas fa-envelope ms-2"></i> ${customer.email}` : ''}
									</small>
									<br>
									<small class="text-muted">
										${customer.type_display} ${customer.age ? `• ${customer.age} years old` : ''}
									</small>
								</div>
								<div>
									<i class="fas fa-chevron-right text-muted"></i>
								</div>
							</div>
						</div>
					`;
				});
				
				resultsContainer.html(html);
				
				// Add click handlers to results
				$('.customer-result').on('click', function() {
					const customerId = $(this).data('customer-id');
					const customer = customers.find(c => c.id === customerId);
					selectGuardian(customer);
				});
			}
			
			function selectGuardian(customer) {
				// Set the hidden select field value
				$('#id_guardian').val(customer.id);
				
				// Show selected customer
				$('#selected-guardian-name').text(customer.name);
				$('#selected-guardian-details').html(
					`<i class="fas fa-phone"></i> ${customer.phone} • ${customer.type_display}${customer.age ? ` • ${customer.age} years old` : ''}`
				);
				$('#selected-guardian').removeClass('d-none');
				
				// Hide search results and clear search input
				$('#guardian-search-results').addClass('d-none').empty();
				$('#guardian-search').val('');
			}
			
			// Clear search and remove guardian selection
			$('#clear-guardian-search').on('click', function() {
				$('#guardian-search').val('');
				$('#guardian-search-results').addClass('d-none').empty();
			});
			
			$('#remove-guardian').on('click', function() {
				$('#id_guardian').val('');
				$('#selected-guardian').addClass('d-none');
				$('#guardian-search').val('');
				$('#guardian-search-results').addClass('d-none').empty();
			});
			
			// Hide search results when clicking outside
			$(document).on('click', function(e) {
				if (!$(e.target).closest('#guardian-search, #guardian-search-results').length) {
					$('#guardian-search-results').addClass('d-none');
				}
			});
		});
	</script>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-3">
    <div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'DjangoHUDApp:pageCustomer' %}">CUSTOMERS</a></li>
            <li class="breadcrumb-item active">ADD CUSTOMER</li>
        </ul>
        <h5>Create New Customer</h5>
    </div>
    <div class="ms-auto">
        <a href="{% url 'DjangoHUDApp:pageCustomer' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Customers
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0"><i class="fas fa-user-plus me-2"></i>Customer Information</h6>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Basic Information Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-user me-2"></i>Basic Information</h6>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="first_name">First Name <span class="text-danger">*</span></label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="last_name">Last Name <span class="text-danger">*</span></label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="phone">Phone Number <span class="text-danger">*</span></label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <div class="text-danger small">{{ form.phone.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="email">Email Address</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger small">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group mb-3">
                        <label class="form-label" for="address">Address</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                            <div class="text-danger small">{{ form.address.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Customer Type & Demographics -->
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-tags me-2"></i>Customer Type & Demographics</h6>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="type_of_customer">Customer Type <span class="text-danger">*</span></label>
                        {{ form.type_of_customer }}
                        {% if form.type_of_customer.errors %}
                            <div class="text-danger small">{{ form.type_of_customer.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="date_of_birth">Date of Birth</label>
                        {{ form.date_of_birth }}
                        {% if form.date_of_birth.errors %}
                            <div class="text-danger small">{{ form.date_of_birth.errors.0 }}</div>
                        {% endif %}
                        <small class="text-muted">Used to determine if customer is a minor</small>
                    </div>
                </div>
                <div class="col-md-6" id="sex-field">
                    <div class="form-group mb-3">
                        <label class="form-label" for="sex">Gender</label>
                        {{ form.sex }}
                        {% if form.sex.errors %}
                            <div class="text-danger small">{{ form.sex.errors.0 }}</div>
                        {% endif %}
                        <small class="text-muted">Required for clients</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="profile_image">Profile Photo</label>
                        {{ form.profile_image }}
                        {% if form.profile_image.errors %}
                            <div class="text-danger small">{{ form.profile_image.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Guardian/Relationship Information -->
            <div class="row mb-4" id="relationship-section">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-users me-2"></i>Guardian & Relationship Information</h6>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <div class="form-check">
                            {{ form.is_minor }}
                            <label class="form-check-label" for="{{ form.is_minor.id_for_label }}">
                                This person is under 18 years old
                            </label>
                        </div>
                        {% if form.is_minor.errors %}
                            <div class="text-danger small">{{ form.is_minor.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-8" id="guardian-field">
                    <div class="form-group mb-3">
                        <label class="form-label" for="guardian">Guardian/Parent</label>
                        
                        <!-- Customer Search Input -->
                        <div class="input-group mb-2">
                            <input type="text" id="guardian-search" class="form-control" 
                                   placeholder="Search customers by name or phone..." 
                                   autocomplete="off">
                            <button type="button" id="clear-guardian-search" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="guardian-search-results" class="border rounded d-none" style="max-height: 200px; overflow-y: auto;">
                            <!-- Results will be populated here -->
                        </div>
                        
                        <!-- Hidden select field (for form submission) -->
                        <div style="display: none;">
                            {{ form.guardian }}
                        </div>
                        
                        <!-- Selected Customer Display -->
                        <div id="selected-guardian" class="alert alert-success d-none">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Selected Guardian:</strong>
                                    <span id="selected-guardian-name"></span>
                                    <br>
                                    <small class="text-muted" id="selected-guardian-details"></small>
                                </div>
                                <button type="button" id="remove-guardian" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                        
                        {% if form.guardian.errors %}
                            <div class="text-danger small">{{ form.guardian.errors.0 }}</div>
                        {% endif %}
                        <small class="text-muted">Required for minors - search and select an adult customer</small>
                        {% if not form.guardian.queryset %}
                            <div class="alert alert-info mt-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>No guardians available:</strong> You need to create at least one adult customer first before adding minors.
                                <a href="{% url 'DjangoHUDApp:pageCustomer' %}" class="alert-link">View existing customers</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6" id="relationship-field">
                    <div class="form-group mb-3">
                        <label class="form-label" for="relationship_to_guardian">Relationship to Guardian</label>
                        {{ form.relationship_to_guardian }}
                        {% if form.relationship_to_guardian.errors %}
                            <div class="text-danger small">{{ form.relationship_to_guardian.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label" for="emergency_contact">Emergency Contact</label>
                        {{ form.emergency_contact }}
                        {% if form.emergency_contact.errors %}
                            <div class="text-danger small">{{ form.emergency_contact.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Business & KYC Information -->
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3"><i class="fas fa-shield-alt me-2"></i>Business & Verification Information</h6>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <div class="form-check">
                            {{ form.kyc_verified }}
                            <label class="form-check-label" for="{{ form.kyc_verified.id_for_label }}">
                                KYC Verified
                            </label>
                        </div>
                        {% if form.kyc_verified.errors %}
                            <div class="text-danger small">{{ form.kyc_verified.errors.0 }}</div>
                        {% endif %}
                        <small class="text-muted">Customer has completed KYC verification process</small>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group mb-3">
                        <label class="form-label" for="notes">Additional Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                        {% endif %}
                        <small class="text-muted">Any additional information about the customer</small>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'DjangoHUDApp:pageCustomer' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Add Customer
                        </button>
                    </div>
                </div>
            </div>
            
        </form>
    </div>
    <div class="card-arrow">
        <div class="card-arrow-top-left"></div>
        <div class="card-arrow-top-right"></div>
        <div class="card-arrow-bottom-left"></div>
        <div class="card-arrow-bottom-right"></div>
    </div>
</div>

<!-- Information Box -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card bg-light">
            <div class="card-body">
                <h6><i class="fas fa-info-circle me-2"></i>Customer Types</h6>
                <ul class="mb-0 small">
                    <li><strong>Wholesaler:</strong> Bulk purchasers with special pricing</li>
                    <li><strong>Retailer:</strong> Business customers who resell products</li>
                    <li><strong>Client:</strong> Individual customers who use services</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-light">
            <div class="card-body">
                <h6><i class="fas fa-users me-2"></i>Guardian System</h6>
                <ul class="mb-0 small">
                    <li>Minors (under 18) require a guardian account</li>
                    <li>Guardians must be KYC verified adults</li>
                    <li>Services can be provided to dependents via guardian's account</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block outter_content %}
{% if form.errors %}
    <div class="toasts-container">
        <div class="toast fade show">
            <div class="toast-header">
                <i class="far fa-bell text-muted me-2"></i>
                <strong class="me-auto">Form Validation Error</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                {% for field, error_msgs in form.errors.items %}
                    {% for error_msg in error_msgs %}
                    <ul>
                        <li>{{ error_msg }}</li>
                    </ul>
                        
                        <br>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
{% endif %}

{% endblock outter_content %}