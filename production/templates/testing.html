{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ page_title|default:"Create Store Sale" }}{% endblock %}

{% block css %}
    <link href="{% static 'plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet" />
    <link href="{% static 'plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet" />
    <link href="{% static 'plugins/bootstrap-table/dist/bootstrap-table.min.css' %}" rel="stylesheet" />
    <link href="/assets/plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <style>
        .form-section {
            
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .section-title {
            
            margin-bottom: 15px;
            font-weight: 600;
        }
        .tax-info {
            {% comment %} background: #e8f4fd; {% endcomment %}
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        .customer-info {
            {% comment %} background: #f8f9fa; {% endcomment %}
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
    </style>
{% endblock %}  

{% block js %}
    <script src="{% static 'plugins/@highlightjs/cdn-assets/highlight.min.js' %}"></script>
    <script src="{% static 'js/demo/highlightjs.demo.js' %}"></script>
    <script src="{% static 'plugins/datatables.net/js/dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/bootstrap-table/dist/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'js/demo/table-plugins.demo.js' %}"></script>
    <script src="{% static 'js/demo/sidebar-scrollspy.demo.js' %}"></script>
    <script src="/assets/plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fa fa-shopping-cart me-2"></i>{{ page_title|default:"Create Store Sale" }}</h2>
            <p class="text-muted mb-0">{{ page_subtitle|default:"Wholesale Customer Sales" }}</p>
        </div>
        <a href="{% url 'listStoreSales' %}" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left me-1"></i>Back to Sales
        </a>
    </div>

    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <!-- Customer Information Section -->
        <div class="form-section">
            <h5 class="section-title"><i class="fa fa-user me-2"></i>Customer Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.customer.id_for_label }}" class="form-label">Customer *</label>
                    {{ form.customer }}
                    {% if form.customer.help_text %}<small class="form-text text-muted">{{ form.customer.help_text }}</small>{% endif %}
                    {% if form.customer.errors %}
                        <div class="invalid-feedback d-block">{{ form.customer.errors.0 }}</div>
                    {% endif %}
                    
                    <!-- Customer Info Display -->
                    <div id="customer-info" class="customer-info" style="display: none;">
                        <strong>Customer Details:</strong>
                        <div id="customer-details"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="{{ form.billing_address.id_for_label }}" class="form-label">Billing Address</label>
                    {{ form.billing_address }}
                    {% if form.billing_address.help_text %}<small class="form-text text-muted">{{ form.billing_address.help_text }}</small>{% endif %}
                    {% if form.billing_address.errors %}
                        <div class="invalid-feedback d-block">{{ form.billing_address.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sale Details Section -->
        <div class="form-section">
            <h5 class="section-title"><i class="fa fa-file-invoice me-2"></i>Sale Details</h5>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                    {{ form.description }}
                    {% if form.description.help_text %}<small class="form-text text-muted">{{ form.description.help_text }}</small>{% endif %}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.due_date.id_for_label }}" class="form-label">Due Date</label>
                    {{ form.due_date }}
                    {% if form.due_date.help_text %}<small class="form-text text-muted">{{ form.due_date.help_text }}</small>{% endif %}
                    {% if form.due_date.errors %}
                        <div class="invalid-feedback d-block">{{ form.due_date.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tax Information Section -->
        <div class="form-section">
            <h5 class="section-title"><i class="fa fa-calculator me-2"></i>Tax Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.tax_code.id_for_label }}" class="form-label">Tax Code</label>
                    {{ form.tax_code }}
                    {% if form.tax_code.help_text %}<small class="form-text text-muted">{{ form.tax_code.help_text }}</small>{% endif %}
                    {% if form.tax_code.errors %}
                        <div class="invalid-feedback d-block">{{ form.tax_code.errors.0 }}</div>
                    {% endif %}
                    
                    <!-- Tax Code Info Display -->
                    <div id="tax-info" class="tax-info" style="display: none;">
                        <small><strong>Tax Details:</strong> <span id="tax-details"></span></small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-4">
                        {{ form.withhold_tax }}
                        <label class="form-check-label" for="{{ form.withhold_tax.id_for_label }}">
                            Apply Withholding Tax (6%)
                        </label>
                    </div>
                    {% if form.withhold_tax.errors %}
                        <div class="invalid-feedback d-block">{{ form.withhold_tax.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="form-section">
            <h5 class="section-title"><i class="fa fa-list me-2"></i>Sale Items</h5>
            
            <!-- Summary Cards -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Subtotal</h6>
                            <h4 class="text-primary mb-0" id="summary-subtotal">UGX 0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Tax Amount</h6>
                            <h4 class="text-info mb-0" id="summary-tax">UGX 0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Withholding Tax</h6>
                            <h4 class="text-warning mb-0" id="summary-withholding">UGX 0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h6 class="card-title">Grand Total</h6>
                            <h4 class="mb-0" id="summary-total">UGX 0</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            {{ formset.management_form }}
            <div class="table-responsive">
                <table class="table table-striped" id="sale_item_formset">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Pricing Group</th>
                            <th>Unit Price</th>
                            <th>Subtotal</th>
                            <th>Tax</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                            <tr class="form-row">
                                <td>{{ form.product }}</td>
                                <td>{{ form.quantity }}</td>
                                <td>{{ form.price_group }}</td>
                                <td>
                                    <input type="number" name="{{ form.chosen_price.name }}" 
                                           id="chosen_price{{ forloop.counter }}" 
                                           class="form-control chosen-price" readonly 
                                           data-row="{{ forloop.counter }}">
                                </td>
                                <td>
                                    <span class="fw-bold text-primary item-subtotal" id="item_subtotal{{ forloop.counter }}">UGX 0</span>
                                </td>
                                <td>
                                    <span class="fw-bold text-info item-tax" id="item_tax{{ forloop.counter }}">UGX 0</span>
                                </td>
                                <td>
                                    <span class="fw-bold text-success item-total" id="item_total{{ forloop.counter }}">UGX 0</span>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm remove-form">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% if form.errors %}
                            <tr>
                                <td colspan="6">
                                    <div class="alert alert-danger alert-sm">{{ form.errors }}</div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="4" class="text-end">Subtotal:</th>
                            <th id="subtotal">UGX 0</th>
                            <th id="total-tax">UGX 0</th>
                            <th id="grand-total">UGX 0</th>
                            <th></th>
                        </tr>
                        <tr id="withholding-row" style="display: none;">
                            <th colspan="6" class="text-end">Withholding Tax:</th>
                            <th id="withholding-amount">UGX 0</th>
                            <th></th>
                        </tr>
                        <tr class="table-primary">
                            <th colspan="6" class="text-end">Grand Total:</th>
                            <th id="final-total">UGX 0</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="mt-3">
                <button type="button" id="add_form" class="btn btn-primary">
                    <i class="fa fa-plus me-1"></i>Add Item
                </button>
                <button class="btn btn-success ms-2" type="submit">
                    <i class="fa fa-save me-1"></i>Create Sale
                </button>
            </div>
        </div>

        <!-- Hidden fields -->
        {{ form.total_items }}
    </form>
</div>
<script>
    $(document).ready(function() {
        // Initialize date picker
        $('#datepicker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        });

        // Customer selection handling
        $('#id_customer').on('change', function() {
            const customerId = $(this).val();
            if (customerId) {
                // Get customer details and populate billing address
                const customerText = $(this).find('option:selected').text();
                const customerDetails = customerText.split(' - ');
                
                // Show customer info
                $('#customer-info').show();
                $('#customer-details').html(`
                    <div class="d-flex justify-content-between">
                        <span>${customerDetails[0]}</span>
                        <span class="badge bg-primary">${customerDetails[1] || 'Customer'}</span>
                    </div>
                `);
                
                // Auto-populate billing address if empty
                if (!$('#id_billing_address').val()) {
                    // You can enhance this with AJAX to get full customer details
                    $('#id_billing_address').val('Address will be populated from customer details...');
                }
            } else {
                $('#customer-info').hide();
                $('#id_billing_address').val('');
            }
        });

        // Tax code selection handling
        $('#id_tax_code').on('change', function() {
            const taxCodeId = $(this).val();
            if (taxCodeId) {
                const taxText = $(this).find('option:selected').text();
                $('#tax-info').show();
                $('#tax-details').text(taxText);
            } else {
                $('#tax-info').hide();
            }
            
            // Recalculate all items when tax code changes
            $('.form-row').each(function() {
                const row = $(this);
                const priceInput = row.find('input[name*="chosen_price"]');
                const quantityInput = row.find('input[name*="quantity"]');
                const subtotalSpan = row.find('.item-subtotal');
                const taxSpan = row.find('.item-tax');
                const totalSpan = row.find('.item-total');
                
                if (priceInput.val() && quantityInput.val()) {
                    updateItemCalculations(priceInput, subtotalSpan, taxSpan, totalSpan, quantityInput);
                }
            });
        });

        // Withholding tax checkbox
        $('#id_withhold_tax').on('change', function() {
            if ($(this).is(':checked')) {
                $('#withholding-row').show();
            } else {
                $('#withholding-row').hide();
            }
            calculateTotals();
        });

        // Product and pricing group change handling
        $(document).on('change', 'select[name*="product"], select[name*="price_group"]', function() {
            const row = $(this).closest('tr');
            const productSelect = row.find('select[name*="product"]');
            const priceGroupSelect = row.find('select[name*="price_group"]');
            const quantityInput = row.find('input[name*="quantity"]');
            const priceInput = row.find('input[name*="chosen_price"]');
            const subtotalSpan = row.find('.item-subtotal');
            const taxSpan = row.find('.item-tax');
            const totalSpan = row.find('.item-total');

            if (productSelect.val() && priceGroupSelect.val()) {
                // Fetch price based on product and price group
                fetchProductPrice(productSelect.val(), priceGroupSelect.val(), priceInput, subtotalSpan, taxSpan, totalSpan, quantityInput);
            } else {
                // Clear price and totals if either product or price group is not selected
                priceInput.val('');
                subtotalSpan.text('UGX 0');
                taxSpan.text('UGX 0');
                totalSpan.text('UGX 0');
                calculateTotals();
            }
        });

        // Quantity change handling
        $(document).on('input', 'input[name*="quantity"]', function() {
            const row = $(this).closest('tr');
            const priceInput = row.find('input[name*="chosen_price"]');
            const subtotalSpan = row.find('.item-subtotal');
            const taxSpan = row.find('.item-tax');
            const totalSpan = row.find('.item-total');
            updateItemCalculations(priceInput, subtotalSpan, taxSpan, totalSpan, $(this));
        });

        // Function to fetch product price
        function fetchProductPrice(productId, priceGroupId, priceInput, subtotalSpan, taxSpan, totalSpan, quantityInput) {
            // Check if price group is selected
            if (!priceGroupId) {
                // Show error for missing price group
                const productSelect = priceInput.closest('tr').find('select[name*="product"]');
                const productName = productSelect.find('option:selected').text();
                
                // Show error in the price input field
                priceInput.val('❌ Price Group Required');
                priceInput.css('color', '#dc3545');
                priceInput.css('font-weight', 'bold');
                
                // Clear calculations
                subtotalSpan.text('UGX 0');
                taxSpan.text('UGX 0');
                totalSpan.text('UGX 0');
                
                // Show error message
                if (productName && productName !== '---------') {
                    alert(`❌ ERROR: Price group is required for "${productName}".\n\nOnly pricing groups set by Finance can be used for sales.\n\nPlease select a pricing group to continue.`);
                }
                return;
            }
            
            $.ajax({
                url: '{% url "get_product_price_groups" 0 %}'.replace('0', productId),
                data: { 'price_group_id': priceGroupId },
                dataType: 'json',
                success: function(data) {
                    if (data.success && data.price) {
                        priceInput.val(data.price);
                        priceInput.css('color', '#000');
                        priceInput.css('font-weight', 'normal');
                        updateItemCalculations(priceInput, subtotalSpan, taxSpan, totalSpan, quantityInput);
                        console.log(`Price fetched: ${data.price} for ${data.product_name} (${data.price_group_name})`);
                    } else {
                        console.error("Error fetching product price:", data.error);
                        priceInput.val('❌ Price Not Configured');
                        priceInput.css('color', '#dc3545');
                        priceInput.css('font-weight', 'bold');
                        subtotalSpan.text('UGX 0');
                        taxSpan.text('UGX 0');
                        totalSpan.text('UGX 0');
                        
                        // Show error message
                        const productSelect = priceInput.closest('tr').find('select[name*="product"]');
                        const productName = productSelect.find('option:selected').text();
                        if (productName && productName !== '---------') {
                            alert(`❌ ERROR: No price configured for "${productName}" in the selected price group.\n\nPlease contact Finance to set up pricing for this product.`);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching product price:", error);
                    priceInput.val('❌ Error Loading Price');
                    priceInput.css('color', '#dc3545');
                    priceInput.css('font-weight', 'bold');
                    subtotalSpan.text('UGX 0');
                    taxSpan.text('UGX 0');
                    totalSpan.text('UGX 0');
                }
            });
        }

        // Update item calculations
        function updateItemCalculations(priceInput, subtotalSpan, taxSpan, totalSpan, quantityInput) {
            const price = parseFloat(priceInput.val()) || 0;
            const quantity = parseFloat(quantityInput.val()) || 0;
            const subtotal = price * quantity;
            
            // Calculate tax for this item
            let taxAmount = 0;
            const taxCodeSelect = $('#id_tax_code');
            if (taxCodeSelect.val()) {
                const taxText = taxCodeSelect.find('option:selected').text();
                const taxMatch = taxText.match(/(\d+\.?\d*)%/);
                if (taxMatch) {
                    const taxRate = parseFloat(taxMatch[1]) / 100;
                    taxAmount = subtotal * taxRate;
                }
            }
            
            const total = subtotal + taxAmount;
            
            subtotalSpan.text('UGX ' + subtotal.toLocaleString());
            taxSpan.text('UGX ' + taxAmount.toLocaleString());
            totalSpan.text('UGX ' + total.toLocaleString());
            
            calculateTotals();
        }

        // Calculate all totals
        function calculateTotals() {
            let subtotal = 0;
            let totalTax = 0;
            let grandTotal = 0;
            
            // Calculate subtotal and tax from all items
            $('.item-subtotal').each(function() {
                const subtotalText = $(this).text().replace('UGX ', '').replace(/,/g, '');
                const itemSubtotal = parseFloat(subtotalText) || 0;
                subtotal += itemSubtotal;
            });
            
            $('.item-tax').each(function() {
                const taxText = $(this).text().replace('UGX ', '').replace(/,/g, '');
                const itemTax = parseFloat(taxText) || 0;
                totalTax += itemTax;
            });
            
            grandTotal = subtotal + totalTax;

            $('#subtotal').text('UGX ' + subtotal.toLocaleString());
            $('#total-tax').text('UGX ' + totalTax.toLocaleString());
            $('#grand-total').text('UGX ' + grandTotal.toLocaleString());

            // Calculate withholding tax
            let withholdingAmount = 0;
            if ($('#id_withhold_tax').is(':checked')) {
                withholdingAmount = grandTotal * 0.06; // 6% withholding tax
                $('#withholding-row').show();
            } else {
                $('#withholding-row').hide();
            }
            $('#withholding-amount').text('UGX ' + withholdingAmount.toLocaleString());

            // Calculate final total (including withholding tax)
            const finalTotal = grandTotal + withholdingAmount;
            $('#final-total').text('UGX ' + finalTotal.toLocaleString());
        }

        // Check for missing price groups before form submission
        $('form').on('submit', function(e) {
            let missingPriceGroups = [];
            
            $('select[name*="product"]').each(function() {
                const productSelect = $(this);
                const productName = productSelect.find('option:selected').text();
                const row = productSelect.closest('tr');
                const priceGroupSelect = row.find('select[name*="price_group"]');
                const quantityInput = row.find('input[name*="quantity"]');
                
                // Only check if product and quantity are selected
                if (productName && productName !== '---------' && quantityInput.val() && parseFloat(quantityInput.val()) > 0) {
                    if (!priceGroupSelect.val()) {
                        missingPriceGroups.push(productName);
                    }
                }
            });
            
            if (missingPriceGroups.length > 0) {
                e.preventDefault();
                const message = `❌ ERROR: Price groups are required for the following products:\n\n${missingPriceGroups.join('\n')}\n\nOnly pricing groups set by Finance can be used for sales.\n\nPlease select pricing groups for all products before creating the sale.`;
                alert(message);
                return false;
            }
        });

        // Add new form row
        $('#add_form').click(function() {
            const formsetDiv = $('#sale_item_formset tbody');
            const totalForms = parseInt($('#id_saleitem_set-TOTAL_FORMS').val());
            const newFormHtml = `
                <tr class="form-row">
                    <td>
                        <select name="saleitem_set-${totalForms}-product" class="form-control" required>
                            <option value="">Select Product</option>
                            {% for product in formset.0.product.field.queryset %}
                            <option value="{{ product.id }}">{{ product.product.product_name }} ({{ product.quantity }} available)</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="saleitem_set-${totalForms}-quantity" class="form-control" min="1" required>
                    </td>
                    <td>
                        <select name="saleitem_set-${totalForms}-price_group" class="form-control">
                            <option value="">Select Price Group</option>
                            {% for group in price_groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="saleitem_set-${totalForms}-chosen_price" class="form-control chosen-price" readonly>
                    </td>
                    <td>
                        <span class="fw-bold text-primary item-subtotal">UGX 0</span>
                    </td>
                    <td>
                        <span class="fw-bold text-info item-tax">UGX 0</span>
                    </td>
                    <td>
                        <span class="fw-bold text-success item-total">UGX 0</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-form">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            formsetDiv.append(newFormHtml);
            $('#id_saleitem_set-TOTAL_FORMS').val(totalForms + 1);
        });

        // Remove form row
        $(document).on('click', '.remove-form', function() {
            $(this).closest('tr').remove();
            calculateTotals();
        });

        // Form validation
        $('form').on('submit', function(e) {
            let isValid = true;
            const customerSelect = $('#id_customer');
            
            if (!customerSelect.val()) {
                isValid = false;
                customerSelect.addClass('is-invalid');
                alert('Please select a customer');
            } else {
                customerSelect.removeClass('is-invalid');
            }

            // Check if at least one item is added
            if ($('.form-row').length === 0) {
                isValid = false;
                alert('Please add at least one item to the sale');
            }

            if (!isValid) {
                e.preventDefault();
            }
        });

        // Initialize calculations on page load
        calculateTotals();
    });
</script>

{% endblock %}
{% block outter_content %}
<script>
    $('#datepicker').datepicker({
      autoclose: true
    });
  </script>
{% if messages %}
    <div class="toasts-container">
        {% for message in messages %}
            <div class="toast fade show">
                <div class="toast-header">
                    <i class="far fa-bell text-muted me-2"></i>
                    <strong class="me-auto">Error Creating Sale</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <p>{{ message }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if form.errors %}  {% endif %}

{% endblock outter_content %}