{% extends 'base.html' %}

{% load static %}

{% block title %}Production Order Approval{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr/latest/toastr.min.css">
    <link href="{% static 'plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" />
    <link href="{% static 'plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet" />
    <link href="{% static 'plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet" />
    <link href="{% static 'plugins/bootstrap-table/dist/bootstrap-table.min.css' %}" rel="stylesheet" />
    <style>
        .availability-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .availability-header {
            {% comment %} background: #f8f9fa; {% endcomment %}
            {% comment %} color: #495057; {% endcomment %}
            padding: 15px;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #dee2e6;
        }
        .ingredient-row {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .ingredient-row:last-child {
            border-bottom: none;
        }
        .sufficient {
            {% comment %} background-color: #f8f9fa; {% endcomment %}
            border-left: 3px solid #28a745;
        }
        .insufficient {
            background-color: #fff5f5;
            border-left: 3px solid #dc3545;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .badge-sufficient {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .badge-insufficient {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .summary-card {
            {% comment %} background: #f8f9fa; {% endcomment %}
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .warning-card {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .success-card {
            background: green;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'plugins/@highlightjs/cdn-assets/highlight.min.js' %}"></script>
    <script src="{% static 'js/demo/highlightjs.demo.js' %}"></script>
    <script src="{% static 'plugins/datatables.net/js/dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/bootstrap-table/dist/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'js/demo/table-plugins.demo.js' %}"></script>
    <script src="{% static 'js/demo/sidebar-scrollspy.demo.js' %}"></script>
{% endblock %}

{% block content %}
    
        <!-- BEGIN container -->
        <div class="container">
            <!-- BEGIN row -->
            <div class="row justify-content-center">
                <!-- BEGIN col-10 -->
                <div class="col-xl-12">
                    <!-- BEGIN row -->
                    <div class="row">
                        <!-- BEGIN col-9 -->
                        <div class="col-xl-9">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="#">PRODUCTS</a></li>
                                <li class="breadcrumb-item active">APPROVE PRODUCTION ORDER</li>
                            </ul>
                            
                            <h1 class="page-header">
                                APPROVE ORDER <small>{{ production_order.product.product_name }}</small>
                            </h1>
                            
                            <hr class="mb-4">
                            
                            <!-- Production Order Summary -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fa fa-info-circle me-2"></i>Order Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Product:</strong> {{ production_order.product.product_name }}</p>
                                            <p><strong>Requested by:</strong> {{ production_order.requested_by.username }}</p>
                                            <p><strong>Requested Quantity:</strong> {{ production_order.quantity }} units</p>
                                            <p><strong>Status:</strong> <span class="badge bg-warning">{{ production_order.status }}</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    {% if availability_check.overall_sufficient %}
                                    <div class="success-card">
                                        <h5><i class="fa fa-check-circle me-2"></i>✅ Production Feasible</h5>
                                        <p class="mb-2"><strong>Can produce:</strong> {{ availability_check.can_produce_quantity }} units</p>
                                        <p class="mb-0">All ingredients are available for the requested quantity.</p>
                                    </div>
                                    {% else %}
                                    <div class="warning-card">
                                        <h5><i class="fa fa-exclamation-triangle me-2"></i>⚠️ Ingredient Shortage</h5>
                                        <p class="mb-2"><strong>Maximum producible:</strong> {{ availability_check.can_produce_quantity }} units</p>
                                        <p class="mb-2"><strong>Shortage cost:</strong> UGX {{ availability_check.total_shortage_cost|floatformat:0 }}</p>
                                        <p class="mb-0">Some ingredients are insufficient for full production.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Ingredient Availability Check -->
                            <div class="availability-card">
                                <div class="availability-header">
                                    <h5 class="mb-0"><i class="fa fa-flask me-2"></i>Ingredient Availability Analysis</h5>
                                    <small>Required vs Available Stock for {{ production_order.quantity }} units</small>
                                </div>
                                <div class="card-body p-0">
                                    {% for ingredient in availability_check.ingredients %}
                                    <div class="ingredient-row {% if ingredient.is_sufficient %}sufficient{% else %}insufficient{% endif %}">
                                        <div class="row align-items-center">
                                            <div class="col-md-3">
                                                <strong>{{ ingredient.raw_material.name }}</strong>
                                                <br><small class="text-muted">Stock in {{ ingredient.unit_measurement }}</small>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <div class="mb-1">
                                                    <strong>{{ ingredient.total_quantity_needed_display|floatformat:2 }}</strong>
                                                    <br><small class="text-muted">Required
                                                    {% if ingredient.unit_measurement|lower == 'kilograms' or ingredient.unit_measurement|lower == 'kg' %}
                                                    (grams)
                                                    {% elif ingredient.unit_measurement|lower == 'liters' or ingredient.unit_measurement|lower == 'litres' %}
                                                    (ml)
                                                    {% else %}
                                                    ({{ ingredient.unit_measurement }})
                                                    {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <div class="mb-1">
                                                    <strong>{{ ingredient.current_stock|floatformat:2 }}</strong>
                                                    <br><small class="text-muted">Available ({{ ingredient.unit_measurement }})</small>
                                                    <br><small class="text-muted">= {{ ingredient.current_stock_base_units|floatformat:0 }}
                                                    {% if ingredient.unit_measurement|lower == 'kilograms' or ingredient.unit_measurement|lower == 'kg' %}
                                                    grams
                                                    {% elif ingredient.unit_measurement|lower == 'liters' or ingredient.unit_measurement|lower == 'litres' %}
                                                    ml
                                                    {% else %}
                                                    {{ ingredient.unit_measurement }}
                                                    {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                {% if ingredient.is_sufficient %}
                                                <span class="status-badge badge-sufficient">✓ Sufficient</span>
                                                {% else %}
                                                <span class="status-badge badge-insufficient">✗ Short: {{ ingredient.shortage_base_units|floatformat:0 }}
                                                {% if ingredient.unit_measurement|lower == 'kilograms' or ingredient.unit_measurement|lower == 'kg' %}
                                                g
                                                {% elif ingredient.unit_measurement|lower == 'liters' or ingredient.unit_measurement|lower == 'litres' %}
                                                ml
                                                {% else %}
                                                {{ ingredient.display_unit }}
                                                {% endif %}
                                                </span>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <small class="text-muted">{{ ingredient.price_source }}</small>
                                                {% if not ingredient.is_sufficient and ingredient.shortage_cost > 0 %}
                                                <br><small class="text-danger">Cost: UGX {{ ingredient.shortage_cost|floatformat:0 }}</small>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-1 text-center">
                                                {% if ingredient.is_sufficient %}
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                                </div>
                                                {% else %}
                                                <div class="progress" style="height: 8px;">
                                                    {% widthratio ingredient.current_stock_base_units ingredient.total_quantity_needed_display 100 as progress_width %}
                                                    <div class="progress-bar bg-warning" style="width: {% if progress_width > 100 %}100{% else %}{{ progress_width }}{% endif %}%"></div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="ingredient-row">
                                        <p class="text-muted mb-0">No ingredients configured for this product.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Approval Form -->
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fa fa-gavel me-2"></i>Approval Decision</h5>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                        {% for message in messages %}
                                        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="approved_quantity" class="form-label">Approved Quantity:</label>
                                                <input 
                                                    class="form-control" 
                                                    type="number" 
                                                    name="approved_quantity" 
                                                    id="approved_quantity" 
                                                    max="{{ production_order.quantity }}"
                                                    min="1"
                                                    {% if availability_check.overall_sufficient %}
                                                    value="{{ production_order.quantity }}"
                                                    {% else %}
                                                    value="{{ availability_check.can_produce_quantity }}"
                                                    {% endif %}
                                                >
                                                <small class="form-text text-muted">
                                                    Maximum recommended: {{ availability_check.can_produce_quantity }} units
                                                    {% if not availability_check.overall_sufficient %}
                                                    (based on available ingredients)
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <div class="col-md-6 d-flex align-items-end">
                                                <button class="btn btn-success me-2" type="submit">
                                                    <i class="fa fa-check me-1"></i>Approve Order
                                                </button>
                                                <a href="{% url 'productionProduction' %}" class="btn btn-secondary">
                                                    <i class="fa fa-arrow-left me-1"></i>Back to List
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr/latest/toastr.min.js"></script>
                            <script>
                                $(document).ready(function() {
                                    // Check for error message in a hidden form field (optional)
                                    if ($('#error_message').val()) {
                                        toastr.error($('#error_message').val());
                                    }

                                    // Update approval recommendation based on ingredient availability
                                    const maxRecommended = {{ availability_check.can_produce_quantity }};
                                    const requestedQuantity = {{ production_order.quantity }};
                                    
                                    $('#approved_quantity').on('input', function() {
                                        const value = parseInt($(this).val());
                                        const helpText = $(this).siblings('.form-text');
                                        
                                        if (value > maxRecommended) {
                                            helpText.removeClass('text-muted').addClass('text-warning');
                                            helpText.html(`⚠️ Warning: Insufficient ingredients for ${value} units. Consider approving ${maxRecommended} units maximum.`);
                                        } else {
                                            helpText.removeClass('text-warning').addClass('text-muted');
                                            helpText.html(`Maximum recommended: ${maxRecommended} units {% if not availability_check.overall_sufficient %}(based on available ingredients){% endif %}`);
                                        }
                                    });
                                });
                            </script>
                        
                                
                            <!-- END #datatable -->
                        </div>
                        <!-- END col-9-->
                        <!-- BEGIN col-3 -->
                        <div class="col-xl-3">
                            <!-- BEGIN #sidebar-bootstrap -->
                            <nav id="sidebar-bootstrap" class="navbar navbar-sticky d-none d-xl-block">
                                <nav class="nav">
                                    <a class="nav-link active" href="{% url 'createProduct' %}">Create Production Order</a>
                                    <a class="nav-link" href="{% url 'productionList' %}">Production Order List</a>
                                    {% if availability_check.overall_sufficient %}
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <h6 class="text-success">✅ Ready to Produce</h6>
                                        <small class="text-muted">All ingredients available</small>
                                    </div>
                                    {% else %}
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <h6 class="text-warning">⚠️ Check Procurement</h6>
                                        <small class="text-muted">Some ingredients may need restocking</small>
                                    </div>
                                    {% endif %}
                                </nav>
                            </nav>
                            <!-- END #sidebar-bootstrap -->
                        </div>
                        <!-- END col-3 -->
                    </div>
                    <!-- END row -->
                </div>
                <!-- END col-10 -->
            </div>
            <!-- END row -->
        </div>
        <!-- END container -->
        
{% endblock %}
