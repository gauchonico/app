{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Supplier Management Dashboard{% endblock %}

{% block css %}
	<link href="{% static 'plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet" />
	<link href="{% static 'plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet" />
	<style>
		.metric-card {
			border-left: 4px solid;
			transition: all 0.3s ease;
		}
		.metric-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(0,0,0,0.1);
		}
		.metric-card.primary { border-left-color: #007bff; }
		.metric-card.success { border-left-color: #28a745; }
		.metric-card.warning { border-left-color: #ffc107; }
		.metric-card.danger { border-left-color: #dc3545; }
		.metric-card.info { border-left-color: #17a2b8; }
		
		.supplier-status-badge {
			font-size: 0.75rem;
			padding: 0.25rem 0.5rem;
		}
		
		.quality-stars {
			color: #ffc107;
		}
		
		.activity-indicator {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			display: inline-block;
			margin-right: 5px;
		}
		.activity-recent { background-color: #28a745; }
		.activity-old { background-color: #6c757d; }
		.activity-none { background-color: #dc3545; }
		
		.filter-section {
			background-color: #f8f9fa;
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 1rem;
		}
		
		.performance-bar {
			height: 6px;
			background-color: #e9ecef;
			border-radius: 3px;
			overflow: hidden;
		}
		.performance-fill {
			height: 100%;
			transition: width 0.3s ease;
		}
		.performance-excellent { background-color: #28a745; }
		.performance-good { background-color: #17a2b8; }
		.performance-average { background-color: #ffc107; }
		.performance-poor { background-color: #dc3545; }
	</style>
{% endblock %}

{% block js %}
	<script src="{% static 'plugins/datatables.net/js/dataTables.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-buttons/js/buttons.colVis.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
	<script src="{% static 'plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js' %}"></script>
	<script>
		$(document).ready(function() {
			$('#suppliersTable').DataTable({
				responsive: true,
				dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
				order: [[2, 'desc']], // Sort by recent activity by default
				columnDefs: [
					{ orderable: false, targets: [0, -1] }, // Disable sorting for # and actions
					{ className: "text-center", targets: [0, 2, 3, 4, 5, 6, 7, -1] }
				],
				language: {
					search: "Search suppliers:",
					lengthMenu: "Show _MENU_ suppliers per page",
					info: "Showing _START_ to _END_ of _TOTAL_ suppliers"
				}
			});
			
			// Filter functionality
			$('.filter-select').on('change', function() {
				updateFilters();
			});
			
			function updateFilters() {
				const quality = $('#qualityFilter').val();
				const active = $('#activeFilter').val();
				const paymentTerms = $('#paymentTermsFilter').val();
				
				const params = new URLSearchParams();
				if (quality) params.append('quality', quality);
				if (active) params.append('active', active);
				if (paymentTerms) params.append('payment_terms', paymentTerms);
				
				const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
				window.location.href = newUrl;
			}
			
			// Clear filters
			$('#clearFilters').on('click', function() {
				window.location.href = window.location.pathname;
			});
		});
	</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
	<!-- Page Header -->
	<div class="d-flex align-items-center justify-content-between mb-4">
		<div>
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb mb-2">
					<li class="breadcrumb-item"><a href="#">Production</a></li>
					<li class="breadcrumb-item active">Supplier Management</li>
				</ol>
			</nav>
			<h1 class="h3 mb-0">Supplier Management Dashboard</h1>
			<p class="text-muted">Comprehensive supplier performance and analytics</p>
		</div>
		<div class="d-flex gap-2">
			<a href="{% url 'addSupplier' %}" class="btn btn-primary">
				<i class="fas fa-plus me-2"></i>Add New Supplier
			</a>
			<div class="dropdown">
				<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
					<i class="fas fa-download me-2"></i>Export
				</button>
				<ul class="dropdown-menu">
					<li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
					<li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
					<li><a class="dropdown-item" href="#"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
				</ul>
			</div>
		</div>
	</div>

	<!-- Analytics Cards -->
	<div class="row mb-4">
		<div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
			<div class="card metric-card primary h-100">
				<div class="card-body text-center">
					<div class="d-flex align-items-center justify-content-center mb-2">
						<i class="fas fa-users fa-2x text-primary me-2"></i>
						<div>
							<h3 class="mb-0">{{ total_suppliers }}</h3>
							<small class="text-muted">Total Suppliers</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
			<div class="card metric-card success h-100">
				<div class="card-body text-center">
					<div class="d-flex align-items-center justify-content-center mb-2">
						<i class="fas fa-check-circle fa-2x text-success me-2"></i>
						<div>
							<h3 class="mb-0">{{ active_suppliers }}</h3>
							<small class="text-muted">Active Suppliers</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
			<div class="card metric-card warning h-100">
				<div class="card-body text-center">
					<div class="d-flex align-items-center justify-content-center mb-2">
						<i class="fas fa-exclamation-triangle fa-2x text-warning me-2"></i>
						<div>
							<h3 class="mb-0">{{ suppliers_with_outstanding }}</h3>
							<small class="text-muted">Outstanding Payments</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
			<div class="card metric-card info h-100">
				<div class="card-body text-center">
					<div class="d-flex align-items-center justify-content-center mb-2">
						<i class="fas fa-star fa-2x text-info me-2"></i>
						<div>
							<h3 class="mb-0">{{ avg_reliability|floatformat:1 }}</h3>
							<small class="text-muted">Avg. Reliability</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
			<div class="card metric-card primary h-100">
				<div class="card-body text-center">
					<div class="d-flex align-items-center justify-content-center mb-2">
						<i class="fas fa-file-invoice fa-2x text-primary me-2"></i>
						<div>
							<h3 class="mb-0">{{ recent_requisitions }}</h3>
							<small class="text-muted">Requisitions (30d)</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
			<div class="card metric-card success h-100">
				<div class="card-body text-center">
					<div class="d-flex align-items-center justify-content-center mb-2">
						<i class="fas fa-shopping-cart fa-2x text-success me-2"></i>
						<div>
							<h3 class="mb-0">{{ recent_purchase_orders }}</h3>
							<small class="text-muted">Purchase Orders (30d)</small>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Filters Section -->
	<div class="filter-section">
		<div class="row align-items-end">
			<div class="col-md-3 col-sm-6 mb-3">
				<label for="qualityFilter" class="form-label">Quality Rating</label>
				<select id="qualityFilter" class="form-select filter-select">
					<option value="">All Qualities</option>
					{% for value, label in quality_choices %}
						<option value="{{ value }}" {% if selected_quality == value %}selected{% endif %}>{{ label }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-3 col-sm-6 mb-3">
				<label for="activeFilter" class="form-label">Status</label>
				<select id="activeFilter" class="form-select filter-select">
					<option value="">All Status</option>
					<option value="true" {% if selected_active == 'true' %}selected{% endif %}>Active</option>
					<option value="false" {% if selected_active == 'false' %}selected{% endif %}>Inactive</option>
				</select>
			</div>
			<div class="col-md-3 col-sm-6 mb-3">
				<label for="paymentTermsFilter" class="form-label">Payment Terms</label>
				<select id="paymentTermsFilter" class="form-select filter-select">
					<option value="">All Terms</option>
					{% for value, label in payment_terms_choices %}
						<option value="{{ value }}" {% if selected_payment_terms == value %}selected{% endif %}>{{ label }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-3 col-sm-6 mb-3">
				<button id="clearFilters" class="btn btn-outline-secondary w-100">
					<i class="fas fa-times me-2"></i>Clear Filters
				</button>
			</div>
		</div>
	</div>

	<!-- Suppliers Table -->
	<div class="card">
		<div class="card-header">
			<h5 class="card-title mb-0">
				<i class="fas fa-table me-2"></i>Supplier Performance Overview
			</h5>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table id="suppliersTable" class="table table-hover table-bordered">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>Supplier Details</th>
							<th>Activity Status</th>
							<th>Quality & Performance</th>
							<th>Recent Orders (30d)</th>
							<th>Payment Status</th>
							<th>Materials</th>
							<th>Credit Status</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for analytics in supplier_analytics %}
						{% with supplier=analytics.supplier %}
						<tr>
							<!-- Supplier Number -->
							<td>{{ forloop.counter }}</td>
							
							<!-- Supplier Details -->
							<td>
								<div class="d-flex flex-column">
									<a href="{% url 'supplier_details' supplier.id %}" class="fw-bold text-decoration-none">
										{{ supplier.name }}
									</a>
									<small class="text-muted">{{ supplier.company_name }}</small>
									<small class="text-muted">
										<i class="fas fa-phone fa-xs me-1"></i>{{ supplier.contact_number|default:"N/A" }}
									</small>
									<div class="mt-1">
										<span class="badge supplier-status-badge {% if supplier.is_active %}bg-success{% else %}bg-secondary{% endif %}">
											{{ supplier.is_active|yesno:"Active,Inactive" }}
										</span>
									</div>
								</div>
							</td>
							
							<!-- Activity Status -->
							<td>
								<div class="d-flex align-items-center justify-content-center">
									<span class="activity-indicator {% if analytics.has_recent_activity %}activity-recent{% elif analytics.latest_activity %}activity-old{% else %}activity-none{% endif %}"></span>
									<div class="text-center">
										{% if analytics.latest_activity %}
											<small class="d-block">{{ analytics.latest_activity|timesince }} ago</small>
											<small class="text-muted">{{ analytics.latest_activity|date:"M d, Y" }}</small>
										{% else %}
											<small class="text-muted">No activity</small>
										{% endif %}
									</div>
								</div>
							</td>
							
							<!-- Quality & Performance -->
							<td>
								<div class="text-center">
									<!-- Quality Rating -->
									<div class="mb-1">
										<span class="badge bg-{% if supplier.quality_rating == 'excellent' %}success{% elif supplier.quality_rating == 'good' %}info{% elif supplier.quality_rating == 'average' %}warning{% else %}danger{% endif %}">
											{{ supplier.get_quality_rating_display }}
										</span>
									</div>
									
									<!-- Reliability Score -->
									<div class="performance-bar mb-1">
										<div class="performance-fill performance-{% if analytics.performance_score >= 8 %}excellent{% elif analytics.performance_score >= 6 %}good{% elif analytics.performance_score >= 4 %}average{% else %}poor{% endif %}" 
											 style="width: {{ analytics.performance_score|floatformat:0 }}0%"></div>
									</div>
									<small class="text-muted">{{ analytics.performance_score|floatformat:1 }}/10</small>
								</div>
							</td>
							
							<!-- Recent Orders -->
							<td>
								<div class="text-center">
									<div class="row">
										<div class="col-6">
											<div class="fw-bold text-primary">{{ analytics.recent_requisitions }}</div>
											<small class="text-muted">Requisitions</small>
										</div>
										<div class="col-6">
											<div class="fw-bold text-success">{{ analytics.recent_purchase_orders }}</div>
											<small class="text-muted">Purchase Orders</small>
										</div>
									</div>
									{% if analytics.total_order_value > 0 %}
									<hr class="my-1">
									<div class="fw-bold text-info">
										UGX {{ analytics.total_order_value|floatformat:0|intcomma }}
									</div>
									<small class="text-muted">Total Value</small>
									{% endif %}
								</div>
							</td>
							
							<!-- Payment Status -->
							<td>
								<div class="text-center">
									{% if analytics.outstanding_amount > 0 %}
										<div class="text-danger fw-bold">
											UGX {{ analytics.outstanding_amount|floatformat:0|intcomma }}
										</div>
										<small class="text-muted">Outstanding</small>
									{% else %}
										<div class="text-success">
											<i class="fas fa-check-circle"></i>
										</div>
										<small class="text-muted">All Clear</small>
									{% endif %}
									
									{% if analytics.paid_amount_90days > 0 %}
									<hr class="my-1">
									<div class="text-muted small">
										UGX {{ analytics.paid_amount_90days|floatformat:0|intcomma }}
									</div>
									<small class="text-muted">Paid (90d)</small>
									{% endif %}
								</div>
							</td>
							
							<!-- Materials -->
							<td>
								<div class="text-center">
									<div class="fw-bold text-secondary">{{ analytics.raw_materials_count }}</div>
									<small class="text-muted">Materials</small>
								</div>
							</td>
							
							<!-- Credit Status -->
							<td>
								<div class="text-center">
									{% if supplier.credit_limit > 0 %}
										<div class="fw-bold">{{ analytics.credit_utilization|floatformat:1 }}%</div>
										<small class="text-muted">of UGX {{ supplier.credit_limit|floatformat:0|intcomma }}</small>
										{% if analytics.credit_utilization > 80 %}
											<div class="text-danger small"><i class="fas fa-exclamation-triangle"></i> High Usage</div>
										{% endif %}
									{% else %}
										<small class="text-muted">No Credit Limit</small>
									{% endif %}
								</div>
							</td>
							
							<!-- Actions -->
							<td>
								<div class="d-flex justify-content-center gap-1">
									<a href="{% url 'supplier_details' supplier.id %}" 
									   class="btn btn-sm btn-outline-info" title="View Details">
										<i class="fas fa-eye"></i>
									</a>
									<a href="{% url 'editSupplier' supplier.id %}" 
									   class="btn btn-sm btn-outline-primary" title="Edit">
										<i class="fas fa-edit"></i>
									</a>
									{% if analytics.outstanding_amount > 0 %}
									<button class="btn btn-sm btn-outline-warning" title="Outstanding Payment">
										<i class="fas fa-exclamation-triangle"></i>
									</button>
									{% endif %}
								</div>
							</td>
						</tr>
						{% endwith %}
						{% empty %}
						<tr>
							<td colspan="9" class="text-center py-4">
								<i class="fas fa-users fa-3x text-muted mb-3"></i>
								<h5 class="text-muted">No suppliers found</h5>
								<p class="text-muted">Try adjusting your filters or add a new supplier</p>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Additional Insights Section -->
	{% if top_suppliers_by_value or attention_suppliers %}
	<div class="row mt-4">
		{% if top_suppliers_by_value %}
		<div class="col-lg-6 mb-4">
			<div class="card">
				<div class="card-header">
					<h6 class="card-title mb-0">
						<i class="fas fa-trophy me-2 text-warning"></i>Top Suppliers by Order Value (30 days)
					</h6>
				</div>
				<div class="card-body">
					{% for analytics in top_suppliers_by_value %}
					{% if analytics.total_order_value > 0 %}
					<div class="d-flex justify-content-between align-items-center mb-2">
						<div>
							<a href="{% url 'supplier_details' analytics.supplier.id %}" class="text-decoration-none">
								{{ analytics.supplier.name|truncatechars:25 }}
							</a>
						</div>
						<div class="text-end">
							<span class="fw-bold text-success">UGX {{ analytics.total_order_value|floatformat:0|intcomma }}</span>
						</div>
					</div>
					{% endif %}
					{% endfor %}
				</div>
			</div>
		</div>
		{% endif %}
		
		{% if attention_suppliers %}
		<div class="col-lg-6 mb-4">
			<div class="card">
				<div class="card-header">
					<h6 class="card-title mb-0">
						<i class="fas fa-exclamation-circle me-2 text-danger"></i>Suppliers Needing Attention
					</h6>
				</div>
				<div class="card-body">
					{% for analytics in attention_suppliers|slice:":5" %}
					<div class="d-flex justify-content-between align-items-center mb-2">
						<div>
							<a href="{% url 'supplier_details' analytics.supplier.id %}" class="text-decoration-none">
								{{ analytics.supplier.name|truncatechars:25 }}
							</a>
						</div>
						<div class="text-end">
							{% if analytics.outstanding_amount > 0 %}
								<span class="badge bg-danger">Outstanding Payment</span>
							{% endif %}
							{% if analytics.performance_score < 4.0 %}
								<span class="badge bg-warning">Low Performance</span>
							{% endif %}
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
		{% endif %}
	</div>
	{% endif %}
</div>
{% endblock %}
