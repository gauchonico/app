{% extends 'base.html' %}
{% load static %}

{% block css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Close Cash Drawer</h2>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Session #{{ session.id }}</h5>
            <p class="card-text">
                <strong>Opened:</strong> {{ session.opening_time|date:"M d, Y H:i" }}<br>
                <strong>Opened by:</strong> {{ session.user.get_full_name|default:session.user.username }}<br>
                <strong>Opening Balance:</strong> {{ session.opening_balance|floatformat:2 }}<br>
                <strong>Total Transactions:</strong> {{ total_transactions|floatformat:2 }}<br>
                <strong>Expected Balance:</strong> {{ expected_balance|floatformat:2 }}
            </p>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Close Session</h5>
            <form method="post">
                {% csrf_token %}
                {{ form.expected_balance }}
                {{ form.opening_balance }}
                {{ form.total_transactions }}
                {{ form.difference }}
                
                <div class="alert alert-info mb-3">
                    <p class="mb-1"><strong>Recommended carry-forward float:</strong> {{ effective_carry_forward_float|floatformat:2 }}</p>
                    <p class="mb-0"><strong>Recommended bank deposit:</strong> {{ recommended_deposit|floatformat:2 }}</p>
                </div>

                <div class="form-group mb-3">
                    <label for="{{ form.closing_balance.id_for_label }}">Actual Closing Balance</label>
                    {{ form.closing_balance }}
                    {% if form.closing_balance.errors %}
                        <div class="text-danger">
                            {{ form.closing_balance.errors }}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.carry_forward_float.id_for_label }}">Float to carry forward</label>
                    {{ form.carry_forward_float }}
                    <small class="form-text text-muted">If left blank, opening balance will be used.</small>
                </div>

                <div class="form-group mb-3">
                    <label for="{{ form.bank_amount.id_for_label }}">Amount to bank</label>
                    {{ form.bank_amount }}
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.bank_account.id_for_label }}">Bank Account</label>
                            {{ form.bank_account }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.cash_drawer_account.id_for_label }}">Cash at Hand Account</label>
                            {{ form.cash_drawer_account }}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">Notes</label>
                    {{ form.notes }}
                </div>
                
                <button type="submit" class="btn btn-primary">Close Drawer &amp; Save Banking</button>
                <a href="{% url 'cash_drawer_detail' session_id=session.id %}" class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-calculate difference when closing balance changes
document.addEventListener('DOMContentLoaded', function() {
    const closingBalance = document.querySelector('#{{ form.closing_balance.id_for_label }}');
    const expectedBalance = document.querySelector('#{{ form.expected_balance.id_for_label }}');
    const differenceField = document.querySelector('#{{ form.difference.id_for_label }}');
    
    function calculateDifference() {
        const closing = parseFloat(closingBalance.value) || 0;
        const expected = parseFloat(expectedBalance.value) || 0;
        const difference = (closing - expected).toFixed(2);
        differenceField.value = difference;
    }
    
    closingBalance.addEventListener('change', calculateDifference);
    closingBalance.addEventListener('keyup', calculateDifference);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(function() {
    $('select[name="bank_account"], select[name="cash_drawer_account"]').select2({
      width: '100%',
      placeholder: 'Select account',
      allowClear: true
    });
  });
</script>
{% endblock %}
