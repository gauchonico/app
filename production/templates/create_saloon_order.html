{% extends 'base.html' %}

{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}POS - Customer Order System{% endblock %}
{% block css %}
	<link href="/assets/plugins/select-picker/dist/picker.min.css" rel="stylesheet">
	
	<style>
	.customer-search {
		position: relative;
	}
	.customer-dropdown {
		position: absolute;
		top: 100%;
		left: 0;
		right: 0;
		border: 1px solid #ddd;
		border-top: none;
		max-height: 200px;
		overflow-y: auto;
		z-index: 1000;
		display: none;
	}
	.customer-item {
		padding: 10px;
		cursor: pointer;
		border-bottom: 1px solid #eee;
	}
	.customer-item:hover {
		background: white opacity(0.9);
	}
	.customer-item:last-child {
		border-bottom: none;
	}
	</style>
	
	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
	<style>
		.select2-container .select2-selection {
			height: calc(1.5em + 0.75rem + 2px);
			padding: 0.375rem 0.75rem;
			font-size: 1rem;
			color: rgb(24, 19, 18);
			border: 1px solid rgb(15, 184, 85);
		}
		
		.select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
			line-height: 1.5;
			padding-left: 0;
		}
		
		.select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
			height: calc(1.5em + 0.75rem);
		}
		.select2-container--default .select2-search--inline .select2-search__field {
			color: rgb(24, 19, 18);
		}
		.select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
			background-color: rgb(15, 184, 85);
			color: rgb(24, 19, 18);
		}
		.select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
			background-color: rgb(15, 184, 85);
			color: rgb(255, 255, 255);
		}
		.select2-container--default .select2-selection--multiple .select2-selection__choice {
			background-color: rgb(15, 184, 85);
			border: 1px solid #ffffff;
		}
		
		.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
			color: rgb(9, 77, 37);
			border-right: 1px solid rgb(6, 70, 33);

		}
		.item-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
			gap: 1.5rem;
			padding: 1rem;
		}
	
		.item-card {
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: blur(10px);
			border-radius: 15px;
			overflow: hidden;
			transition: all 0.3s ease;
			height: 100%;
		}
	
		.item-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 20px rgba(0,0,0,0.1);
		}
	
		.item-content {
			padding: 1.5rem;
		}
	
		.item-title {
			font-size: 0.8rem;
			font-weight: 600;
			margin-bottom: 0.5rem;
			color: var(--bs-theme);
		}
	
		.item-price {
			font-size: 1.2rem;
			font-weight: 700;
			color: var(--bs-theme);
		}
	
		.item-stock {
			font-size: 0.9rem;
			color: #6c757d;
			margin-bottom: 1rem;
		}
	
		.item-badge {
			position: absolute;
			top: 1rem;
			right: 1rem;
			padding: 0.1rem 1rem;
			border-radius: 20px;
			font-size: 0.5rem;
			font-weight: 600;
		}
		.cart-section-header {
			border-bottom: 1px solid rgba(255,255,255,0.1);
			margin-bottom: 10px;
		}
		
		.cart-section-header h6 {
			color: var(--bs-theme);
			font-weight: 600;
		}
		
		.pos-order {
			margin-bottom: 8px;
		}
	
		.badge-service {
			background-color: rgba(var(--bs-theme-rgb), 0.1);
			color: var(--bs-theme);
		}
	
		.badge-product {
			background-color: rgba(var(--bs-info-rgb), 0.1);
			color: var(--bs-info);
		}
	
		.badge-accessory {
			background-color: rgba(var(--bs-warning-rgb), 0.1);
			color: var(--bs-warning);
		}
	
		.empty-state {
			text-align: center;
			padding: 3rem;
			color: #6c757d;
		}
	
		.empty-state i {
			font-size: 3rem;
			margin-bottom: 1rem;
		}
		
		.text-danger i {
			margin-right: 0.5rem;
		}
		
		#selectedPrice .text-danger {
			font-size: 0.9rem;
			margin-bottom: 0.5rem;
		}
		
		#selectedPrice .text-muted {
			font-size: 0.8rem;
		}
		
		#addPriceLink {
			margin-top: 1rem;
		}
	</style>
{% endblock %}
{% block js %}
	<script>
		// Cart management
		let cart = {
			customer: null,
			items: [],
			totals: {
				subtotal: 0,
				total: 0
			}
		};

	let customers = [];
	let selectedCustomerId = null;
	

		// Store existing cart data for later processing
		let existingCartData = null;
		{% if existing_cart_json %}
		try {
			existingCartData = JSON.parse('{{ existing_cart_json|escapejs }}');
			console.log('Loaded existing cart data:', existingCartData);
			console.log('Existing cart items breakdown:', {
				services: existingCartData.items?.filter(item => item.type === 'service').length || 0,
				products: existingCartData.items?.filter(item => item.type === 'product').length || 0,
				accessories: existingCartData.items?.filter(item => item.type === 'accessory').length || 0
			});
		} catch (e) { console.error('Failed to parse existing cart', e); }
		{% endif %}

		function addServiceToCart() {
			const staffSelect = document.getElementById('serviceStaff');
			const selectedStaff = Array.from(staffSelect.selectedOptions).map(option => ({
				id: option.value,
				name: option.text
			}));
			
			if (selectedStaff.length === 0) {
				alert('Please select at least one staff member');
				return;
			}
			
			
			const serviceItem = {
				type: 'service',
				id: parseInt(selectedService.id),
				name: selectedService.name,
				quantity: 1,
				price: parseFloat(selectedService.price),
				total: parseFloat(selectedService.price),
				selected_staff: selectedStaff.map(staff => staff.id)  // Just keep the IDs
			};
			
			cart.items.push(serviceItem);
			updateCartDisplay();
			calculateTotals();
			
			bootstrap.Modal.getInstance(document.getElementById('serviceModal')).hide();
		}

		// add product to cart
		function addProductToCart() {
			console.log('addProductToCart called with selectedProduct:', selectedProduct);
			
			const staffSelect = document.getElementById('productStaff');
			const selectedStaff = staffSelect.value ? {
				id: staffSelect.value,
				name: staffSelect.options[staffSelect.selectedIndex].text
			} : null;
		
			// Ensure we have a valid price
			if (!selectedProduct.price || isNaN(selectedProduct.price)) {
				console.error('Invalid price for product:', selectedProduct);
				alert('Invalid price for this product. Please try selecting the product again.');
				return;
			}
		
			
			const quantity = parseInt(document.getElementById('productQuantity').value) || 1;
			const unitPrice = parseFloat(selectedProduct.price);
    		const total = quantity * unitPrice;

			// Validate the calculations
			if (isNaN(total)) {
				alert('Error calculating total price');
				return;
			}
			
			const productItem = {
				type: 'product',
				id: selectedProduct.id,
				name: selectedProduct.name,
				quantity: quantity,
				unit_price: unitPrice,
				total: total,
				staff: selectedStaff
			};
			
			console.log('Adding product to cart:', productItem);
			
			cart.items.push(productItem);
			updateCartDisplay();
			calculateTotals();
			
			bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
		}

		//add accessories to cart
		function addAccessoryToCart() {
			const quantity = parseFloat(document.getElementById('accessoryQuantity').value);
			const unitPrice = parseFloat(selectedAccessory.price);
			
			const accessoryItem = {
				type: 'accessory',
				id: parseInt(selectedAccessory.id),
				name: selectedAccessory.name,
				quantity: quantity,
				unit_price: unitPrice,
				total: unitPrice * quantity
			};
			
			console.log('Adding accessory to cart:', accessoryItem);
			
			cart.items.push(accessoryItem);
			updateCartDisplay();
			
			
			bootstrap.Modal.getInstance(document.getElementById('accessoryModal')).hide();
		}

		// show service model
		function showServiceModal(serviceId, serviceName, servicePrice) {
			console.log('Opening service modal:', serviceId);
			selectedService = {
				id: serviceId,
				name: serviceName,
				price: parseFloat(servicePrice)
			};
			
			// Update modal content
			document.getElementById('serviceName').textContent = serviceName;
			
			// Show the modal using Bootstrap
			const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
			modal.show();
		}

		// Update the product modal display
		function showProductModal(productId, productName, stock) {
			// Store product details
			selectedProduct = {
				id: productId,
				name: productName,
				price: null,
				stock: parseInt(stock) || 0
			};
			
			// Update modal title
			document.getElementById('productName').textContent = productName;
			document.getElementById('productQuantity').value = 1;
			document.getElementById('productQuantity').max = stock;
			document.getElementById('selectedPrice').textContent = 'Loading price...';

			// Try to get retail price group first, then fallback to any available price group
			const url = `/production/get_product_price_groups/${productId}/`;

			// Fetch price with retail price group preference
			fetch(url)
				.then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					console.log('Received price data for product', productId, ':', data); // Debug log
            
					if (data.success && data.price) {
						const productPrice = parseFloat(data.price);
						
						if (isNaN(productPrice)) {
							throw new Error('Invalid price received from server');
						}
						
						console.log('Setting selectedProduct.price to:', productPrice);
						selectedProduct.price = productPrice;
						document.getElementById('selectedPrice').textContent = 
							`UGX ${productPrice.toLocaleString()}`;
						
						// Set price group if available
						if (data.price_group_name) {
						document.getElementById('priceGroup').value = data.price_groups[0].id;
						}
						
						document.querySelector('#productModal .btn-theme').disabled = false;
					} else {
						// Show message and disable Add Product button when no price is found
						document.getElementById('selectedPrice').innerHTML = `
							<div class="text-danger">
								<i class="bi bi-exclamation-triangle"></i> No price set in any price group
							</div>
							<small class="text-muted">Please add a price for this product in a price group first</small>
						`;
						// Disable the Add Product button
						document.querySelector('#productModal .btn-theme').disabled = true;
					}
				})
				.catch(error => {
					console.error('Error fetching price for product', productId, ':', error);
					document.getElementById('selectedPrice').innerHTML = `
						<div class="text-danger">
							<i class="bi bi-exclamation-triangle"></i> Error loading price: ${error.message}
						</div>
						<small class="text-muted">Please ensure a price is set for this product in a price group</small>
					`;
					// Disable the Add Product button
					document.querySelector('#productModal .btn-theme').disabled = true;
					selectedProduct.price = null; // Ensure price is reset on error
				});

			// Show the modal
			const modal = new bootstrap.Modal(document.getElementById('productModal'));
			modal.show();
		}

		// Function to update the displayed price when price group changes
		function updateProductPrice() {
			const priceGroupSelect = document.getElementById('priceGroup');
			const selectedOption = priceGroupSelect.selectedOptions[0];
			const priceDisplay = document.getElementById('selectedPrice');
			
			if (selectedOption && selectedOption.dataset.price) {
				const price = parseFloat(selectedOption.dataset.price);
				const formattedPrice = price.toLocaleString('en-US', {
					style: 'currency',
					currency: 'UGX',
					minimumFractionDigits: 0,
					maximumFractionDigits: 0
				});
				priceDisplay.textContent = formattedPrice;
			} else {
				priceDisplay.textContent = 'Please select a price group';
			}
		}
	



		// Update the modal HTML to pass the modal ID

		function showAccessoryModal(accessoryId, name, price, stock) {
			console.log('Opening accessory modal:', accessoryId);
			selectedAccessory = {
				id: accessoryId,
				name: name,
				price: parseFloat(price),
				stock: parseInt(stock)
			};
			
			document.getElementById('accessoryName').textContent = name;
			document.getElementById('accessoryQuantity').value = 1;
			document.getElementById('accessoryQuantity').max = stock;
			
			const modal = new bootstrap.Modal(document.getElementById('accessoryModal'));
			modal.show();
		}



		function getCookie(name) {
			let cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				const cookies = document.cookie.split(';');
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim();
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}

		// Customer search functionality
		function setupCustomerSearch() {
			const customerSearch = document.getElementById('customerSearch');
			const customerDropdown = document.getElementById('customerDropdown');
			
			customerSearch.addEventListener('input', function() {
				const query = this.value.toLowerCase().trim();
				console.log('Customer search query:', query);
				console.log('Available customers:', customers);
				
				if (query.length < 1) {
					customerDropdown.style.display = 'none';
					return;
				}
				
				const filteredCustomers = customers.filter(customer => 
					customer.first_name.toLowerCase().includes(query) ||
					customer.last_name.toLowerCase().includes(query) ||
					customer.phone.includes(query)
				);
				
				console.log('Filtered customers:', filteredCustomers);
				
				if (filteredCustomers.length > 0) {
					customerDropdown.innerHTML = filteredCustomers.map(customer => 
						`<div class="customer-item" onclick="selectCustomer(${customer.id}, '${customer.first_name} ${customer.last_name}')">
							<strong>${customer.first_name} ${customer.last_name}</strong><br>
							<small class="text-muted">${customer.phone}</small>
						</div>`
					).join('');
					customerDropdown.style.display = 'block';
				} else {
					customerDropdown.innerHTML = `
						<div class="customer-item" onclick="showNewCustomerModal()">
							<i class="fas fa-plus me-2"></i>Create new customer: "${query}"
						</div>
					`;
					customerDropdown.style.display = 'block';
				}
			});
			
			// Hide dropdown when clicking outside
			document.addEventListener('click', function(e) {
				if (!customerSearch.contains(e.target) && !customerDropdown.contains(e.target)) {
					customerDropdown.style.display = 'none';
				}
			});
		}

		function selectCustomer(customerId, customerName) {
			selectedCustomerId = customerId;
			cart.customer = customerId;
			document.getElementById('selectedCustomerId').value = customerId;
			document.getElementById('selectedCustomerName').textContent = customerName;
			document.getElementById('selectedCustomerInfo').style.display = 'block';
			document.getElementById('customerSearch').value = '';
			document.getElementById('customerDropdown').style.display = 'none';
			updateCartDisplay();
		}

		function clearCustomer() {
			selectedCustomerId = null;
			cart.customer = null;
			document.getElementById('selectedCustomerId').value = '';
			document.getElementById('selectedCustomerInfo').style.display = 'none';
			updateCartDisplay();
		}

		function showNewCustomerModal() {
			document.getElementById('customerDropdown').style.display = 'none';
			
			// Pre-fill the form with the search query if it looks like a name
			const searchQuery = document.getElementById('customerSearch').value.trim();
			if (searchQuery) {
				const nameParts = searchQuery.split(' ');
				if (nameParts.length >= 2) {
					document.getElementById('newCustomerFirstName').value = nameParts[0];
					document.getElementById('newCustomerLastName').value = nameParts.slice(1).join(' ');
				} else {
					document.getElementById('newCustomerFirstName').value = searchQuery;
				}
			}
			
			new bootstrap.Modal(document.getElementById('customerModal')).show();
		}

		function createCustomer() {
			const firstName = document.getElementById('newCustomerFirstName').value;
			const lastName = document.getElementById('newCustomerLastName').value;
			const phone = document.getElementById('newCustomerPhone').value;
			const email = document.getElementById('newCustomerEmail').value;
			
			if (!firstName || !lastName || !phone) {
				alert('Please fill in all required fields');
				return;
			}
			
			// Create customer via AJAX
			fetch('{% url "DjangoHUDApp:create_customer_ajax" %}', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': getCookie('csrftoken')
				},
				body: JSON.stringify({
					first_name: firstName,
					last_name: lastName,
					phone: phone,
					email: email
				})
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
					// Add to customers array
					customers.push(data.customer);
					// Select the new customer
					selectCustomer(data.customer.id, `${data.customer.first_name} ${data.customer.last_name}`);
					// Close modal
					bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
					// Clear form
					document.getElementById('newCustomerForm').reset();
					} else {
					alert('Error creating customer: ' + data.error);
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Error creating customer');
				});
		}

		// Initialize customer search functionality
		document.addEventListener('DOMContentLoaded', function() {
			// Convert customers to JavaScript array
			customers = [
				{% for customer in customers %}
				{
					id: {{ customer.id }},
					first_name: "{{ customer.first_name|escapejs }}",
					last_name: "{{ customer.last_name|escapejs }}",
					phone: "{{ customer.phone|escapejs }}",
					email: "{{ customer.email|escapejs|default:'' }}"
				}{% if not forloop.last %},{% endif %}
				{% endfor %}
			];
			
			console.log('Customers loaded:', customers);
			
			// Load available staff for display
			window.availableStaff = [
				{% for staff in available_staff %}
				{
					id: {{ staff.id }},
					name: "{{ staff.name|escapejs }}"
				}{% if not forloop.last %},{% endif %}
				{% endfor %}
			];
			console.log('Available staff loaded:', window.availableStaff);
			
			// Setup customer search
			setupCustomerSearch();
			
			// Process existing cart data if available (for edit mode)
			if (existingCartData) {
				try {
					cart = existingCartData;
					console.log('Applied existing cart:', cart);
					console.log('Existing cart items:', cart.items);
					console.log('Cart items by type:', {
						services: cart.items.filter(item => item.type === 'service'),
						products: cart.items.filter(item => item.type === 'product'),
						accessories: cart.items.filter(item => item.type === 'accessory')
					});
					
					// Ensure totals object exists and is properly initialized
					if (!cart.totals) {
						cart.totals = { subtotal: 0, total: 0 };
					}
					
					// Validate and fix any missing totals in existing items
					cart.items.forEach((item, index) => {
						console.log(`Validating item ${index}:`, item);
						if (!item.total || isNaN(item.total)) {
							console.warn(`Item ${index} missing total, recalculating:`, item);
							if (item.unit_price && item.quantity) {
								item.total = parseFloat(item.unit_price) * parseFloat(item.quantity);
								console.log(`Recalculated total for ${item.name}: ${item.total}`);
							}
						}
					});
					
					// Set customer if available
					if (cart.customer) {
						selectedCustomerId = cart.customer;
						// Find and select the customer in the search interface
						const customer = customers.find(c => c.id === cart.customer);
						if (customer) {
							document.getElementById('selectedCustomerId').value = cart.customer;
							document.getElementById('selectedCustomerName').textContent = `${customer.first_name} ${customer.last_name}`;
							document.getElementById('selectedCustomerInfo').style.display = 'block';
						}
					}
					
					// Update display
					updateCartDisplay();
					calculateTotals();
				} catch (e) {
					console.error('Failed to apply existing cart:', e);
				}
			}
		});

		// Product quantity handlers
		function incrementQuantity(modalId) {
			const input = document.getElementById(`${modalId}Quantity`);
			const max = parseInt(input.max) || Infinity;
			const currentValue = parseInt(input.value);
			if (currentValue < max) {
				input.value = currentValue + 1;
			}
		}

		function decrementQuantity(modalId) {
			const input = document.getElementById(`${modalId}Quantity`);
			const currentValue = parseInt(input.value);
			if (currentValue > 1) {
				input.value = currentValue - 1;
			}
		}

		// Cart Display and Management Functions
		function updateCartDisplay() {
			const cartContainer = document.getElementById('cartItems');
			if (!cartContainer) {
				console.error('Cart container not found');
				return;
			}
			
			console.log('Updating cart with items:', cart.items);
			cartContainer.innerHTML = '';
			
			// Group items by type for organized display
			const groupedItems = {
				services: cart.items.filter(item => item.type === 'service'),
				products: cart.items.filter(item => item.type === 'product'),
				accessories: cart.items.filter(item => item.type === 'accessory'),
				refreshments: cart.items.filter(item => item.type === 'refreshment')
			};
			
			console.log('Grouped items for display:', groupedItems);

			// Display Services
			if (groupedItems.services.length > 0) {
				appendCartHeader(cartContainer, 'Services');
				groupedItems.services.forEach((item, groupIndex) => {
					const globalIndex = cart.items.findIndex(cartItem => 
						cartItem === item || 
						(cartItem.type === 'service' && cartItem.id === item.id && cartItem.name === item.name)
					);
					appendCartItem(cartContainer, item, globalIndex);
				});
			}

			// Display Products
			if (groupedItems.products.length > 0) {
				appendCartHeader(cartContainer, 'Products');
				groupedItems.products.forEach((item, groupIndex) => {
					const globalIndex = cart.items.findIndex(cartItem => 
						cartItem === item || 
						(cartItem.type === 'product' && cartItem.id === item.id && cartItem.name === item.name)
					);
					appendCartItem(cartContainer, item, globalIndex);
				});
			}

			// Display Accessories
			if (groupedItems.accessories.length > 0) {
				appendCartHeader(cartContainer, 'Accessories');
				groupedItems.accessories.forEach((item, groupIndex) => {
					const globalIndex = cart.items.findIndex(cartItem => 
						cartItem === item || 
						(cartItem.type === 'accessory' && cartItem.id === item.id && cartItem.name === item.name)
					);
					appendCartItem(cartContainer, item, globalIndex);
				});
			}

			//Display Refreshments
			if (groupedItems.refreshments.length > 0) {
				appendCartHeader(cartContainer, 'Refreshments');
				groupedItems.refreshments.forEach((item, groupIndex) => {
					const globalIndex = cart.items.findIndex(cartItem => 
						cartItem === item || 
						(cartItem.type === 'refreshment' && cartItem.id === item.id && cartItem.name === item.name)
					);
					appendCartItem(cartContainer, item, globalIndex);
				});
			}
		}

		function appendCartHeader(container, title) {
			const header = document.createElement('div');
			header.className = 'cart-section-header';
			header.innerHTML = `<h6 class="mb-2 mt-3">${title}</h6>`;
			container.appendChild(header);
		}

		function appendCartItem(container, item, index) {
			console.log(`Appending cart item ${index}:`, item);
			const itemElement = document.createElement('div');
			itemElement.className = 'pos-order';
			
			let staffHtml = '';
			if (item.type === 'service' && (item.selected_staff || item.staff_ids)) {
				const staffIds = item.selected_staff || item.staff_ids;
				// For existing items, we only have IDs, so we need to get staff names from available_staff
				if (Array.isArray(staffIds) && staffIds.length > 0) {
					const staffNames = staffIds.map(id => {
						const staff = window.availableStaff?.find(s => s.id === id);
						return staff ? staff.name : `Staff ${id}`;
					});
				staffHtml = `
					<div class="small">
							Staff: ${staffNames.join(', ')}
					</div>
				`;
				}
			} else if (item.type === 'product' && (item.staff || item.staff_id)) {
				let staffName = '';
				if (item.staff && item.staff.name) {
					staffName = item.staff.name;
				} else if (item.staff_id) {
					const staff = window.availableStaff?.find(s => s.id === item.staff_id);
					staffName = staff ? staff.name : `Staff ${item.staff_id}`;
				}
				if (staffName) {
				staffHtml = `
					<div class="small">
							Commission Staff: ${staffName}
					</div>
				`;
				}
			}

			let quantityHtml = item.type !== 'service' ? 
				`<div class="small">Quantity: ${item.quantity} x UGX ${item.unit_price.toLocaleString()}</div>` : '';

			itemElement.innerHTML = `
				<div class="pos-order-product">
					<div class="flex-1">
						<div class="h6 mb-1">${item.name}</div>
						${quantityHtml}
						${staffHtml}
					</div>
					<div class="pos-order-price">
						UGX ${item.total.toLocaleString()}
					</div>
					<button class="btn btn-sm btn-danger ms-2" onclick="removeFromCart(${index})">
						<i class="bi bi-trash"></i>
					</button>
				</div>
			`;
			
			container.appendChild(itemElement);
		}

		function removeFromCart(index) {
			cart.items.splice(index, 1);
			updateCartDisplay();
			calculateTotals();
		}

		function calculateTotals() {
			console.log('Calculating totals for items:', cart.items);
			
			// Ensure totals object exists
			if (!cart.totals) {
				cart.totals = { subtotal: 0, total: 0 };
			}
			
			cart.totals.subtotal = cart.items.reduce((sum, item) => {
				// Skip accessories in total calculation
				if (item.type === 'accessory') {
					console.log('Skipping accessory:', item.name);
					return sum;
				}
				
				const itemTotal = parseFloat(item.total) || 0;
				console.log(`Adding ${item.type} "${item.name}": ${itemTotal} (running total: ${sum + itemTotal})`);
				return sum + itemTotal;
			}, 0);
			
			cart.totals.total = cart.totals.subtotal;
			
			console.log('Final calculated totals:', cart.totals);
			
			// Format the totals with proper number handling
			const formattedSubtotal = cart.totals.subtotal.toLocaleString();
			const formattedTotal = cart.totals.total.toLocaleString();
			
			console.log('Formatted totals:', { subtotal: formattedSubtotal, total: formattedTotal });
			
			document.getElementById('subtotal').textContent = `UGX ${formattedSubtotal}`;
			document.getElementById('total').textContent = `UGX ${formattedTotal}`;
		
			return cart.totals.total;
		}

		function clearCart() {
			cart.items = [];
			updateCartDisplay();
			calculateTotals();
		}

	
		function submitSale() {
			// Get required data
			const customerId = selectedCustomerId;
			const storeId = document.getElementById('storeId').value; // Add this hidden input to your template
			console.log('Store ID:', storeId);  // Debug log
			// Debug log for cart items
			console.log('Full cart contents:', cart.items);
			
			if (!customerId) {
				alert('Please select a customer');
				return;
			}

			if (!storeId || storeId === '') {
				alert('Store ID is missing. Please contact your administrator.');
				return;
			}

			if (!cart.items || cart.items.length === 0) {
				alert('Cart is empty');
				return;
			}
			// Get the total amount from calculateTotals
			const totalAmount = calculateTotals();

			// Separate items by type
			const productItems = [];
			const serviceItems = [];
			const accessoryItems = [];
			const refreshmentItems = [];
			const url = `{% if submit_url %}{{ submit_url }}{% else %}/production/new_create_service_sale/{% endif %}`;

			// Filter and validate items before mapping
			const saleData = {
				customer_id: parseInt(customerId),  // Convert to integer
				store_id: parseInt(storeId),       // Convert to integer
				product_items: cart.items
					.filter(item => item.type === 'product')
					.map(item => ({
						product_id: parseInt(item.id),
						quantity: parseInt(item.quantity),
						price_group_id: item.price_group_id ? parseInt(item.price_group_id) : null,
						total_price: parseFloat(item.total),
						staff_id: item.staff ? parseInt(item.staff.id) : (item.staff_id ? parseInt(item.staff_id) : null)
					})),
				service_items: cart.items
					.filter(item => item.type === 'service')
					.map(item => ({
						service_id: parseInt(item.id),
						quantity: parseFloat(item.quantity),
						staff_ids: item.selected_staff || item.staff_ids || [],
						total_price: parseFloat(item.total)
					})),
				accessory_items: cart.items
					.filter(item => item.type === 'accessory')
					.map(item => ({
						accessory_id: parseInt(item.id),
						quantity: parseFloat(item.quantity),
						price: parseFloat(item.unit_price).toFixed(2),
						total_price: parseFloat(item.total).toFixed(2) 
					})),
				refreshment_items: cart.items
					.filter(item => item.type === 'refreshment')
					.map(item => ({
						refreshment_id: parseInt(item.id),
						quantity: parseFloat(item.quantity),
						unit_price: parseFloat(item.unit_price),
						total_price: parseFloat(item.total) 
					})),
				total_amount: totalAmount.toFixed(2),
				paid_status: 'not_paid',
				payment_mode: 'cash'
			};

			console.log('Submitting sale data:', saleData);  // Debug log



			// Submit the sale
			fetch(url, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': getCookie('csrftoken')
				},
				body: JSON.stringify(saleData)
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					alert('Sale created successfully!');
					// Clear the cart
					cart.items = [];
					updateCartDisplay();
					// Redirect to the sale detail page
					window.location.href = data.redirect_url;
				} else {
					alert('Error creating sale: ' + data.error);
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('Error creating sale. Please try again.');
			});
		}
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const searchInput = document.getElementById('globalSearch');
			if (!searchInput) {
				console.error('Search input not found');
				return;
			}
			
			searchInput.addEventListener('keyup', debounce(function() {
				try {
					const searchText = (this.value || '').toLowerCase();
					console.log('Searching for:', searchText);
					
					// Get all item containers
					const allItems = document.querySelectorAll('.col-xxl-3');
					console.log('Found items:', allItems.length);
					
					allItems.forEach(itemContainer => {
						try {
							// Find the info section within the item
							const info = itemContainer.querySelector('.info');
							if (!info) {
								console.log('No info section found for item');
								return;
							}
							
							// Get text content safely
							const title = info.querySelector('.title')?.textContent || '';
							const desc = info.querySelector('.desc')?.textContent || '';
							const price = info.querySelector('.price')?.textContent || '';
							
							// Convert to lowercase for comparison
							const titleLower = title.toLowerCase();
							const descLower = desc.toLowerCase();
							const priceLower = price.toLowerCase();
							
							// Check if any text matches the search
							const matches = searchText === '' || 
										  titleLower.includes(searchText) || 
										  descLower.includes(searchText) || 
										  priceLower.includes(searchText);
							
							// Show/hide the item
							itemContainer.style.display = matches ? '' : 'none';
							
							console.log(`Item "${title}": ${matches ? 'shown' : 'hidden'}`);
						} catch (itemError) {
							console.error('Error processing item:', itemError);
						}
					});
				} catch (error) {
					console.error('Search error:', error);
				}
			}, 300));
		});
		
		// Debounce function
		function debounce(func, wait) {
			let timeout;
			return function executedFunction(...args) {
				const later = () => {
					clearTimeout(timeout);
					func(...args);
				};
				clearTimeout(timeout);
				timeout = setTimeout(later, wait);
			};
		}
		
		// Handle tab switching
		document.querySelectorAll('.nav-link').forEach(tab => {
			tab.addEventListener('click', function(e) {
				e.preventDefault();
				
				// Get the type of items to show
				const filterType = this.getAttribute('data-filter');
				
				// Update active tab
				document.querySelectorAll('.nav-link').forEach(t => {
					t.classList.remove('active');
				});
				this.classList.add('active');
				
				// Show/hide items based on type
				document.querySelectorAll('.col-xxl-3').forEach(item => {
					const itemType = item.getAttribute('data-type');
					item.style.display = (itemType === filterType) ? '' : 'none';
				});
			});
		});
	</script>
	<script>
		// Define the base URL using Django's template tag
		const PRICE_GROUPS_URL = "{% url 'get_product_price_groups' '0' %}".replace('0', '').replace('//', '/');
	</script>
	<script src="{% static 'js/demo/pos-customer-order.demo.js' %}"></script>
	<script src="/assets/plugins/select-picker/dist/picker.min.js"></script>
	<!-- Add before closing body tag, after jQuery -->
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock js %}

{% block content %}
	<!-- Add hidden store ID -->
	<input type="hidden" id="storeId" value="{{ current_store.id }}">

	<!-- BEGIN pos -->
	<div class="pos card" id="pos">
		<div class="pos-container card-body">
			<!-- BEGIN pos-menu -->
			<div class="pos-menu">
				<!-- BEGIN logo -->
				<div class="logo">
					<a href="{% url 'DjangoHUDApp:index' %}">
						<div class="logo-img"><i class="bi bi-pc-display" style="font-size: 2.1rem;"></i></div>
						<div class="logo-text">Dashboard</div>
					</a>
				</div>
				<!-- END logo -->
				<!-- BEGIN nav-container -->
				<div class="nav-container">
					<div data-scrollbar="true" data-height="100%" data-skip-mobile="true">
						<ul class="nav nav-tabs">
							<li class="nav-item">
								<a class="nav-link active" href="#" data-filter="services">
									<div class="card">
										<div class="card-body">
											<i class="fa fa-scissors"></i>Services
										</div>
										<div class="card-arrow">
											<div class="card-arrow-top-left"></div>
											<div class="card-arrow-top-right"></div>
											<div class="card-arrow-bottom-left"></div>
											<div class="card-arrow-bottom-right"></div>
										</div>
									</div>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#" data-filter="products">
									<div class="card">
										<div class="card-body">
											<i class="fa fa-square"></i> Products
										</div>
										<div class="card-arrow">
											<div class="card-arrow-top-left"></div>
											<div class="card-arrow-top-right"></div>
											<div class="card-arrow-bottom-left"></div>
											<div class="card-arrow-bottom-right"></div>
										</div>
									</div>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#" data-filter="accessories">
									<div class="card">
										<div class="card-body">
											<i class="fa fa-american-sign-language-interpreting"></i> Accessories
										</div>
										<div class="card-arrow">
											<div class="card-arrow-top-left"></div>
											<div class="card-arrow-top-right"></div>
											<div class="card-arrow-bottom-left"></div>
											<div class="card-arrow-bottom-right"></div>
										</div>
									</div>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#" data-filter="refreshments">
									<div class="card">
										<div class="card-body">
											<i class="fa fa-coffee"></i> Refreshments
										</div>
										<div class="card-arrow">
											<div class="card-arrow-top-left"></div>
											<div class="card-arrow-top-right"></div>
											<div class="card-arrow-bottom-left"></div>
											<div class="card-arrow-bottom-right"></div>
										</div>
									</div>
								</a>
							</li>
							
						</ul>
					</div>
				</div>
				<!-- END nav-container -->
			</div>
			<!-- END pos-menu -->

		
			<!-- BEGIN Services-content -->
			<!-- BEGIN pos-content -->
<div class="pos-content">
    <div class="pos-content-container h-100 p-4" data-scrollbar="true" data-height="100%">
        <div class="row gx-4">
			<div class="row mb-3">
				<div class="col-8">
					<div class="search-container">
						<form method="GET" class="search-container">
							<div class="input-group">
								<span class="input-group-text">
									<i class="bi bi-search"></i>
								</span>
								<input type="text" 
									   class="form-control search-input" 
									   name="search"
									   id="globalSearch" 
									   value="{{ search_query }}"
									   placeholder="Search for services, products, or accessories..."
									   autocomplete="off">
								<button type="submit" class="btn btn-outline-theme">Search</button>
								{% if search_query %}
									<a href="{% url 'saloon_sale' %}" class="btn btn-outline-secondary">Clear</a>
								{% endif %}
							</div>
						</form>
					</div>
				</div>
			</div>
			{% if not store_services and not store_products and not store_accessories %}
				<div class="empty-state">
					<i class="bi bi-search"></i>
					<h4>No items found</h4>
					<p class="text-theme">Try adjusting your search terms or browse all items</p>
				</div>
			{% endif %}
            <!-- Services -->
			
            {% for service in store_services %}
            <div class="col-xxl-3 col-xl-4 col-lg-6 col-md-4 col-sm-6 pb-4" data-type="services">
                <div class="item-card h-100">
                    <div class="card-body h-100 p-1">
						<span class="item-badge badge-service">%{{service.commission_rate}}</span>
                        <a href="#" class="pos-product service-item" onclick="showServiceModal(
                            '{{ service.service.id }}', 
                            '{{ service.service.name }}', 
                            '{{ service.service.price|floatformat }}',
                            '{{ service.service.commission_rate }}'
                        ); return false;">
                            {% comment %} <div class="img" style="background-image: url({% if service.service.image %}{{ service.service.image.url }}{% else %}{% static 'img/pos/default-service.jpg' %}{% endif %})"></div> {% endcomment %}
                            <div class="info">
                                <div class="item-title">{{ service.service.name }}</div>
                               
                                <div class="price">{{ service.service.price|floatformat|intcomma }}</div>
                            </div>
                        </a>
                    </div>
                    
                </div>
            </div>
            {% endfor %}

            <!-- Products -->
			 
			
            {% for product in store_products %}
            <div class="col-xxl-3 col-xl-4 col-lg-6 col-md-4 col-sm-6 pb-4" data-type="products">
                <div class="item-card h-100">
                    <div class="card-body h-100 p-1">
						<span class="item-badge badge-product">%0.05</span>
                        <a href="#" class="pos-product product-item" onclick="showProductModal(
                            '{{ product.id }}', 
                            '{{ product.product.product_name|escapejs }}',
							'{{ product.quantity}}'
                        ); return false;">
                            <div class="info">
                                <div class="item-title">{{ product.product.product_name }}</div>
                                <div class="">Stock: {{ product.quantity }}</div>
								
								<div class="price">
									{% if selected_price_group %}
									{% for price in product.product.prices.all %}
											{% if price.price_group.id == selected_price_group.id %}
												UGX {{ price.price|floatformat:0|intcomma }}
										{% endif %}
									{% endfor %}
									{% else %}
										{% for price in product.product.prices.all %}
											{% if price.price_group.name|lower == 'retail' %}
												UGX {{ price.price|floatformat:0|intcomma }}
											{% endif %}
										{% endfor %}
									{% endif %}
								</div>
                            </div>
                        </a>
                    </div>
                   
                </div>
            </div>
            {% endfor %}

			<!-- Accessories -->
			{% for accessory in store_accessories %}
			<div class="col-xxl-3 col-xl-4 col-lg-6 col-md-4 col-sm-6 pb-4" data-type="accessories">
				<div class="item-card h-100">
					<div class="card-body h-100 p-1">
						<span class="item-badge badge-accessory">In Stock</span>
						<a href="#" class="pos-product accessory-item" onclick="showAccessoryModal(
							'{{ accessory.accessory.id }}', 
							'{{ accessory.accessory.name }}',
							'{{ accessory.accessory.price|floatformat  }}',
							'{{ accessory.quantity }}'
						); return false;">
							<div class="info">
								<div class="item-title">{{ accessory.accessory.name }}</div>
								<div class="item-desc">Stock: {{ accessory.quantity }}</div>
								<div class="price">{{ accessory.accessory.price|floatformat|intcomma  }}</div>
							</div>
						</a>
					</div>
					
				</div>
			</div>
			{% endfor %}		

			<!-- Refreshments -->
				{% for refreshment in store_refreshments %}
				<div class="col-xxl-3 col-xl-4 col-lg-6 col-md-4 col-sm-6 pb-4" data-type="refreshments">
					<div class="item-card h-100">
						<div class="card-body h-100 p-1">
							<span class="item-badge {% if refreshment.quantity > 0 %}bg-success{% else %}bg-danger{% endif %}">
								{% if refreshment.quantity > 0 %}In Stock{% else %}Out of Stock{% endif %}
							</span>
							<a href="#" class="pos-product refreshment-item" onclick="showRefreshmentModal(
								'{{ refreshment.id }}', 
								'{{ refreshment.name|escapejs }}',
								'{{ refreshment.sale_price|floatformat }}',
								'{{ refreshment.quantity }}'
							); return false;">
								<div class="info">
									<div class="item-title">{{ refreshment.name }}</div>
									<div class="item-desc">Stock: {{ refreshment.quantity|default:0 }}</div>
									<div class="price">UGX {{ refreshment.sale_price|floatformat|intcomma }}</div>
								</div>
							</a>
						</div>
					</div>
				</div>
				{% empty %}
				<div class="col-12">
					<div class="alert alert-info">No refreshments available</div>
				</div>
				{% endfor %}	
        </div>
    </div>
</div>

		<!-- END pos-content -->
		<!-- BEGIN pos-sidebar -->
        <div class="pos-sidebar" id="pos-sidebar">
            <div class="pos-sidebar-header">
                <div class="back-btn">
                    <button type="button" data-toggle-class="pos-mobile-sidebar-toggled" data-toggle-target="#pos" class="btn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                </div>
                <div class="customer-row mb-3">
                    <label class="form-label fw-bold">Customer</label>
                    <div class="customer-search">
                        <input type="text" id="customerSearch" class="form-control" placeholder="Search or select customer..." autocomplete="off">
                        <div class="customer-dropdown" id="customerDropdown"></div>
                    </div>
                    <input type="hidden" id="selectedCustomerId">
                    <div id="selectedCustomerInfo" class="mt-2" style="display: none;">
                        <div class="alert alert-info py-2">
                            <i class="fas fa-user me-2"></i>
                            <span id="selectedCustomerName"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearCustomer()">
                                <i class="fas fa-times"></i>
                    </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pos-sidebar-body">
                <div class="pos-cart" id="cartItems">
                    <!-- Cart items will be dynamically added here -->
                </div>
            </div>
            <div class="pos-sidebar-footer">
                <div class="d-flex align-items-center mb-2">
                    <div>Subtotal</div>
                    <div class="flex-1 text-end h6 mb-0" id="subtotal">0.00</div>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div>Total</div>
                    <div class="flex-1 text-end h4 mb-0" id="total">0.00</div>
                </div>
                <div class="mt-3">
                    <div class="mb-2">
                        <select class="form-select" id="paymentMode">
                            <option value="cash">Cash</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="airtel_money">Airtel Money</option>
                            <option value="visa">Visa</option>
                            <option value="mixed">Mixed</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="paymentRemarks" placeholder="Payment remarks...">
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-default w-150px" onclick="clearCart()">
                            <i class="bi bi-trash"></i> Clear Cart
                        </button>
                        <button class="btn btn-theme w-150px" onclick="submitSale()">
                            <i class="bi bi-check-circle"></i> Submit Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END pos-sidebar -->
			
		</div>
		<div class="card-arrow">
			<div class="card-arrow-top-left"></div>
			<div class="card-arrow-top-right"></div>
			<div class="card-arrow-bottom-left"></div>
			<div class="card-arrow-bottom-right"></div>
		</div>
	</div>
	<!-- END pos -->
	
	<!-- BEGIN pos-mobile-sidebar-toggler -->
	<a href="#" class="pos-mobile-sidebar-toggler" data-toggle-class="pos-mobile-sidebar-toggled" data-toggle-target="#pos">
		<i class="bi bi-bag"></i>
		<span class="badge">5</span>
	</a>
	<!-- END pos-mobile-sidebar-toggler -->


	<!-- Refreshment Modal -->
		<div class="modal fade" id="refreshmentModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="card">
						<div class="card-body">
							<h5 class="card-title" id="refreshmentName"></h5>
							<div class="mb-3">
								<label class="form-label">Price:</label>
								<div class="form-control" id="refreshmentPriceDisplay"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Available Stock: <span id="refreshmentStock"></span></label>
							</div>
							<div class="mb-3">
								<label class="form-label">Quantity:</label>
								<div class="input-group">
									<button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity('refreshment')">-</button>
									<input type="number" class="form-control text-center" id="refreshmentQuantity" min="1" value="1">
									<button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity('refreshment')">+</button>
								</div>
							</div>
							<div class="text-end">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
								<button type="button" class="btn btn-theme" onclick="addRefreshmentToCart()">Add to Cart</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Product Modal -->

	<div class="modal fade" id="productModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="card">
					<div class="card-body">
						<h5 class="card-title" id="productName"></h5>

						<!-- Price Display -->
						<div class="mb-3">
							<label class="form-label">Price:</label>
							<div class="h5" id="selectedPrice">Loading price...</div>
							<input type="hidden" id="priceGroup">
							<div id="addPriceLink" class="d-none">
								<a href="/production/price-groups/" class="btn btn-sm btn-outline-theme mt-2">
									<i class="bi bi-plus-circle"></i> Add Retail Price
								</a>
							</div>
						</div>

						<div class="mb-3">
							<label for="productStaff" class="form-label">Commission Staff (Optional)</label>
							<select id="productStaff" class="form-select">
								<option value="">No staff commission</option>
								{% for staff in available_staff %}
									<option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name }}</option>
								{% endfor %}
							</select>
							<small class="text-muted">Select staff member if they recommended this product (5% commission)</small>
						</div>

						<div class="mb-3">
							<label class="form-label">Quantity:</label>
							<div class="input-group">
								<button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity('product')">-</button>
								<input type="number" class="form-control text-center" id="productQuantity" min="1" value="1">
								<button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity('product')">+</button>
							</div>
						</div>
						<div class="text-end">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
							<button type="button" class="btn btn-theme" onclick="addProductToCart()">Add Product</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Service Modal -->
	<div class="modal fade" id="serviceModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="card">
					<div class="card-body">
						<a href="#" data-bs-dismiss="modal" class="btn-close position-absolute top-0 end-0 m-4"></a>
						<div class="modal-pos-product">
							<div class="modal-pos-product-info">
								<div class="h4 mb-2" id="serviceName"></div>
								<div class="h4 mb-3">Price: <span id="servicePrice"></span></div>
								<div class="mb-3">
									<label class="form-label">Select Staff:</label>
									<select class="form-select select2-staff" id="serviceStaff" multiple>
										{% for staff in available_staff %}
										<option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name }}</option>
										{% endfor %}
									</select>
									<small class="text-muted">Hold Ctrl/Cmd to select multiple staff</small>
								</div>
								<div class="row mt-4">
									<div class="col-6">
										<button class="btn btn-secondary w-100" data-bs-dismiss="modal">Cancel</button>
									</div>
									<div class="col-6">
										<button class="btn btn-theme w-100" onclick="addServiceToCart()">
											Add Service
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		// Global variables to store refreshment data
		let currentRefreshment = {
			id: null,
			name: '',
			price: 0,
			stock: 0
		};

	

		// Function to show the refreshment modal
		function showRefreshmentModal(id, name, price, stock) {
			currentRefreshment = {
				id: id,
				name: name,
				price: parseFloat(price),
				stock: parseInt(stock)
			};

			// Update modal fields
			document.getElementById('refreshmentName').textContent = name;
			document.getElementById('refreshmentPriceDisplay').textContent = 'UGX ' + parseFloat(price).toLocaleString();
			document.getElementById('refreshmentStock').textContent = stock;
			document.getElementById('refreshmentQuantity').value = 1;
			document.getElementById('refreshmentQuantity').max = stock;

			// Reset and configure quantity input
			const quantityInput = document.getElementById('refreshmentQuantity');
			quantityInput.value = 1;
			quantityInput.max = stock;
			quantityInput.min = 1;

			// Show the modal
			var modal = new bootstrap.Modal(document.getElementById('refreshmentModal'));
			modal.show();
		}

		// Function to add refreshment to cart
		function addRefreshmentToCart() {
			const quantity = parseInt(document.getElementById('refreshmentQuantity').value);
			
			if (quantity <= 0 || quantity > currentRefreshment.stock) {
				alert('Invalid quantity');
				return;
			}

			// Create cart item
			const refreshmentItem = {
				type: 'refreshment',
				id: currentRefreshment.id,
				name: currentRefreshment.name,
				quantity: quantity,
				unit_price: currentRefreshment.price,
				total: (currentRefreshment.price * quantity).toFixed(2),
				stock: currentRefreshment.stock
			};

			// Add to cart
			cart.items.push(refreshmentItem);
			updateCartDisplay();
			calculateTotals();
			
			// Hide the modal
			var modal = bootstrap.Modal.getInstance(document.getElementById('refreshmentModal'));
			modal.hide();
		}

		// Add these functions if they don't exist
		function incrementQuantity(type) {
			const input = document.getElementById(`${type}Quantity`);
			const max = type === 'refreshment' ? currentRefreshment.stock : input.max;
			if (parseInt(input.value) < max) {
				input.value = parseInt(input.value) + 1;
			}
		}

		function decrementQuantity(type) {
			const input = document.getElementById(`${type}Quantity`);
			if (parseInt(input.value) > 1) {
				input.value = parseInt(input.value) - 1;
			}
		}
	</script>
	</script>
		// Helper function to get CSRF token
		function getCookie(name) {
			let cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				const cookies = document.cookie.split(';');
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim();
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
}
	<script>
		$(document).ready(function() {
			// Initialize customer search
			$('#customerSelect').select2({
				placeholder: 'Select or Search Customer',
				allowClear: true,
				minimumInputLength: 2,
				ajax: {
					url: "/production/search-customers/",
					dataType: 'json',
					delay: 250,
					data: function (params) {
						return {
							term: params.term,
							page: params.page
						};
					},
					processResults: function (data, params) {
						return {
							results: data.results
						};
					},
					cache: true
				},
				escapeMarkup: function (markup) {
					return markup;
				}
			});

			// Initialize staff select2
			$('.select2-staff').select2({
				dropdownParent: $('#serviceModal'),
				placeholder: 'Select Staff',
				allowClear: true,
				multiple: true,
				minimumInputLength: 3,
				ajax: {
					url: '/production/search-staff/',  // Update with your actual URL
					dataType: 'json',
					delay: 250,
					data: function(params) {
						return {
							term: params.term
						};
					},
					processResults: function(data) {
						return {
							results: [{
								id: '',
								text: 'No staff commission'
							}].concat(data.results)
						};
					},
					cache: true
				}
			});
		});
	</script>
	<!-- Accessory Modal -->
	<div class="modal fade" id="accessoryModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="card">
					<div class="card-body">
						<h5 class="card-title" id="accessoryName"></h5>
						<div class="mb-3">
							<label class="form-label">Quantity:</label>
							<div class="input-group">
								<button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity('accessory')">-</button>
								<input type="number" class="form-control text-center" id="accessoryQuantity" min="1" value="1">
								<button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity('accessory')">+</button>
							</div>
						</div>
						<div class="text-end">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
							<button type="button" class="btn btn-theme" onclick="addAccessoryToCart()">Add Accessory</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Customer Modal -->
	<div class="modal fade" id="customerModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-user-plus me-2"></i>Create New Customer
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="alert alert-info">
						<i class="fas fa-info-circle me-2"></i>
						<strong>Quick Customer Setup:</strong> Only basic information is required. Additional details can be added later during KYC verification.
					</div>
						<form id="newCustomerForm">
							<div class="mb-3">
								<label class="form-label">First Name</label>
							<input type="text" class="form-control" id="newCustomerFirstName" required>
							</div>
							<div class="mb-3">
								<label class="form-label">Last Name</label>
							<input type="text" class="form-control" id="newCustomerLastName" required>
							</div>
							<div class="mb-3">
							<label class="form-label">Phone</label>
							<input type="text" class="form-control" id="newCustomerPhone" required>
							</div>
							<div class="mb-3">
							<label class="form-label">Email</label>
							<input type="email" class="form-control" id="newCustomerEmail">
							</div>
						</form>
					</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="createCustomer()">Create Customer</button>
				</div>
			</div>
		</div>
	</div>
	
	<!-- END MODALS -->
	
{% endblock %}

{% block outter_content %}


{% endblock outter_content %}